{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}
  Credit Ledger - {{ customer.name }}
{% endblock title %}
{% block content %}
  <!-- Page Header -->
  <div class="page-header">
    <h2 class="page-title">{{ customer.name }} - Credit Ledger</h2>
    <div class="page-actions">
      <a href="{% url 'customer:credit_home' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i>
        Back
      </a>
      <a href="{% url 'customer:credit_create' customer.id %}"
         class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Add Payment
      </a>
      <a href="{% url 'customer:credit_auto_reallocate' customer.id %}"
         class="btn btn-warning"
         id="autoReallocateBtn"
         onclick="return confirmAutoReallocate()">
        <i class="fas fa-sync-alt"></i>
        Auto Reallocate
      </a>
      <button type="button" class="btn btn-info" id="downloadReportBtn">
        <i class="fas fa-download"></i>
        Download Report
      </button>
    </div>
  </div>
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb breadcrumb-right">
    <a href="{% url 'base:home' %}" class="breadcrumb-item">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'customer:credit_home' %}" class="breadcrumb-item">Credit</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-active">{{ customer.name }}</span>
  </nav>
  <!-- Main Layout -->
  <div class="col d-flex flex-row">
    <!-- Left Column - Customer Details and Summary -->
    <div class="col-md-2 d-flex flex-column gap-2">
      <!-- Customer Details Column -->
      <div class="column details-column">
        <div class="column-header">
          <h3>
            <i class="fas fa-user"></i> Customer Details
          </h3>
        </div>
        <div class="details-info-compact">
          <div class="detail-name-compact">
            <h4>{{ customer.name }}</h4>
            <span class="detail-status {% if not customer.is_deleted %}status-active{% else %}status-inactive{% endif %}">
              {% if customer.is_deleted %}
                Inactive
              {% else %}
                Active
              {% endif %}
            </span>
          </div>
          <div class="detail-contact-compact">
            <div class="contact-item">
              <i class="fas fa-phone"></i>
              <span>{{ customer.phone_number|phone_number }}</span>
            </div>
            {% if customer.email %}
              <div class="contact-item">
                <i class="fas fa-envelope"></i>
                <span>{{ customer.email }}</span>
              </div>
            {% endif %}
            {% if customer.address %}
              <div class="contact-item">
                <i class="fas fa-map-marker-alt"></i>
                <span>{{ customer.address|truncatechars:50 }}</span>
              </div>
            {% endif %}
            <div class="contact-item">
              <i class="fas fa-calendar"></i>
              <span>{{ customer.created_at|date:"M d, Y" }}</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Summary Cards -->
      <div class="summary-card-compact" id="creditSummaryCard">
        <div class="summary-icon-compact">
          <i class="fas fa-money-bill"></i>
        </div>
        <div class="summary-content-compact">
          <h4>Amounts</h4>
          <div class="summary-stats-compact">
            <div class="stat-item-compact">
              <span class="stat-number-compact counting-number"
                    data-count="{{ customer.credit_summary.credit_amount }}">0</span>
              <span class="stat-label-compact">Total Credit</span>
            </div>
            <div class="stat-item-compact">
              <span class="stat-number-compact counting-number"
                    data-count="{{ customer.credit_summary.debit_amount }}">0</span>
              <span class="stat-label-compact">Total Debit</span>
            </div>
            <div class="stat-item-compact">
              <span class="stat-number-compact counting-number"
                    data-count="{{ customer.credit_summary.balance_amount }}">0</span>
              <span class="stat-label-compact">Outstanding</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Payment Summary Card (FIFO Auto-Allocation) -->
      <div class="summary-card-compact" id="paymentSummaryCard">
        <div class="summary-icon-compact">
          <i class="fas fa-credit-card"></i>
        </div>
        <div class="summary-content-compact">
          <h4>Payments (FIFO)</h4>
          <div class="summary-stats-compact">
            <div class="stat-item-compact">
              <span class="stat-number-compact counting-number"
                    id="total_paid"
                    data-count="{{ customer.credit_summary.debit_amount }}">0</span>
              <span class="stat-label-compact">Total Paid</span>
            </div>
            <div class="stat-item-compact">
              <span class="stat-number-compact counting-number"
                    id="unallocated_amount"
                    data-count="{{ unallocated_amount|default:0 }}">0</span>
              <span class="stat-label-compact">Unallocated</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Right Column - Ledger Table -->
    <div class="col-md-10 d-flex flex-column gap-2 ps-1">
      <!-- Ledger Table -->
      <div class="table-section" id="ledgerSection">
        <div class="table-header">
          <h3>
            <i class="fas fa-file-invoice-dollar"></i> Ledger
          </h3>
          <a href="{% url 'customer:credit_create' customer.id %}"
             class="btn btn-sm btn-primary">
            <i class="fas fa-plus"></i>
            Add Payment
          </a>
        </div>
        <div class="table-container">
          <table class="data-table" id="ledger_table" data-sort="-date">
            <thead>
              <tr>
                <th class="sortable text-center" data-sort="date">Date</th>
                <th class="text-center">Type</th>
                <th class="text-center">Reference</th>
                <th class="text-center">Method</th>
                <th class="text-center">Notes</th>
                <th class="sortable text-center" data-sort="credit">Credit</th>
                <th class="sortable text-center" data-sort="debit">Debit</th>
                <th class="text-center">Allocated</th>
                <th class="sortable text-center" data-sort="outstanding">Outstanding</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="ledger_table_body">
              <tr>
                <td colspan="10" class="text-center p-4">
                  <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    Loading ledger...
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Download Report Modal -->
  <div class="modal-overlay" id="downloadReportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Download Credit Report</h4>
        <button type="button"
                class="btn-close"
                id="closeDownloadModal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="downloadReportForm" class="d-flex flex-column gap-2">
          {% csrf_token %}
          <div class="form-group mb-3">
            <label for="reportDateFilter" class="form-label">Select Date Range</label>
            <select name="date_filter" class="form-select" id="reportDateFilter">
              <option value="this_month">This Month</option>
              <option value="last_month">Last Month</option>
              <option value="this_quarter">This Quarter</option>
              <option value="last_quarter">Last Quarter</option>
              <option value="this_finance">This Finance</option>
              <option value="last_finance">Last Finance</option>
              <option value="custom">Custom Date</option>
            </select>
          </div>
          <!-- Custom Date Inputs (shown when Custom is selected) -->
          <div class="form-group custom-date-inputs " id="customDateInputs">
            <label class="form-label">Select Custom Date Range</label>
            <div class="row gap-2">
              <div class="date-picker custom-date-picker">
                <div class="form-custom cal-icon">
                  <input class="form-input"
                         type="text"
                         id="customFromDate"
                         placeholder="From: dd-mm-yyyy"
                         readonly>
                </div>
              </div>
              <div class="date-picker custom-date-picker">
                <div class="form-custom cal-icon">
                  <input class="form-input"
                         type="text"
                         id="customToDate"
                         placeholder="To: dd-mm-yyyy"
                         readonly>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="send_pdf_statement">
          <i class="fas fa-paper-plane"></i>
          Send PDF Statement
        </button>
        <button type="button" class="btn btn-secondary" id="cancelDownloadBtn">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitDownloadBtn">
          <i class="fas fa-download"></i>
          Download
        </button>
      </div>
    </div>
  </div>
{% endblock content %}
{% block extra_js %}
  <script src="{% static 'js/dateFilterUtils.js' %}"></script>
  <script src="{% static 'js/fetchData.js' %}"></script>
  <script src="{% static 'js/dropdown_style.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Summary card click handlers
      const creditSummaryCard = document.getElementById('creditSummaryCard')
      const paymentSummaryCard = document.getElementById('paymentSummaryCard')
      const ledgerSection = document.getElementById('ledgerSection')
    
      creditSummaryCard.addEventListener('click', function () {
        ledgerSection.scrollIntoView({ behavior: 'smooth' })
      })
    
      paymentSummaryCard.addEventListener('click', function () {
        ledgerSection.scrollIntoView({ behavior: 'smooth' })
      })
      // Initialize AJAX tables
      const urls = {
        ledger: '{% url "customer:fetch_credit_ledger" customer.id %}',
        create_pdf: '{% url "report:credit_ind_pdf" customer.id %}',
        send_pdf: '{% url "report:send_pdf_statement" customer.id %}',
      }

      // Initialize table without form (form is now optional)
      initTableAjax(null, 'ledger_table', urls.ledger, { autoLoad: true });
      initTableSorting('ledger_table');

      // Download Report Modal functionality
      const downloadModal = document.getElementById('downloadReportModal')
      const downloadBtn = document.getElementById('downloadReportBtn')
      const closeModalBtn = document.getElementById('closeDownloadModal')
      const cancelBtn = document.getElementById('cancelDownloadBtn')
      const submitBtn = document.getElementById('submitDownloadBtn')
      const customDateInputs = document.getElementById('customDateInputs')
      const customFromDate = document.getElementById('customFromDate')
      const customToDate = document.getElementById('customToDate')
      const customerId = "{{ customer.id }}"
      let dropdownInitialized = false
      let fromDatePicker = null
      let toDatePicker = null

      // Initialize date pickers for custom inputs
      function initializeCustomDatePickers() {
        if (typeof DatePicker === 'undefined') {
          console.warn('DatePicker.js not loaded - custom date inputs will not work')
          return
        }

        if (!fromDatePicker && customFromDate) {
          try {
            fromDatePicker = new DatePicker('#customFromDate', {
              mode: 'single',
              format: 'd-m-Y',
              showIcon: true,
              iconPosition: 'right',
              clickOpens: true,
              allowInput: false,
              closeOnSelect: true,
              onChange: (date) => {
                if (date) {
                  const isoDate = date.toISOString().split('T')[0]
                  customFromDate.setAttribute('data-iso-date', isoDate)
                }
              }
            })
          } catch (error) {
            console.error('Error initializing from date picker:', error)
          }
        }

        if (!toDatePicker && customToDate) {
          try {
            toDatePicker = new DatePicker('#customToDate', {
              mode: 'single',
              format: 'd-m-Y',
              showIcon: true,
              iconPosition: 'right',
              clickOpens: true,
              allowInput: false,
              closeOnSelect: true,
              onChange: (date) => {
                if (date) {
                  const isoDate = date.toISOString().split('T')[0]
                  customToDate.setAttribute('data-iso-date', isoDate)
                }
              }
            })
          } catch (error) {
            console.error('Error initializing to date picker:', error)
          }
        }
      }

      // Open modal
      downloadBtn.addEventListener('click', function () {
        downloadModal.style.display = 'flex'
        // Reset custom date inputs
        customDateInputs.style.display = 'none'
        customFromDate.value = ''
        customToDate.value = ''
        customFromDate.removeAttribute('data-iso-date')
        customToDate.removeAttribute('data-iso-date')
        
        // Initialize dropdown after modal is shown (only once)
        if (!dropdownInitialized && typeof convertSelectToStyledDropdown !== 'undefined') {
          setTimeout(() => {
            // Check if already converted
            if (!window.reportDateFilter_styled) {
              const selectElement = document.getElementById('reportDateFilter')
              if (selectElement) {
                convertSelectToStyledDropdown('reportDateFilter', {
                  onChange: function(data) {
                    // Show/hide custom date inputs based on selection
                    if (data.value === 'custom') {
                      customDateInputs.style.display = 'block'
                      // Hide date inputs inside dropdown (if they exist)
                      const styledRef = window.reportDateFilter_styled
                      if (styledRef && styledRef.checkBoxes) {
                        const dropdownDateInputs = styledRef.checkBoxes.querySelector('.date-list:last-of-type')
                        if (dropdownDateInputs) {
                          dropdownDateInputs.style.display = 'none'
                        }
                      }
                      // Initialize date pickers when custom is selected
                      setTimeout(() => {
                        initializeCustomDatePickers()
                      }, 50)
                    } else {
                      customDateInputs.style.display = 'none'
                      // Show date inputs in dropdown again (if they exist)
                      const styledRef = window.reportDateFilter_styled
                      if (styledRef && styledRef.checkBoxes) {
                        const dropdownDateInputs = styledRef.checkBoxes.querySelector('.date-list:last-of-type')
                        if (dropdownDateInputs) {
                          dropdownDateInputs.style.display = 'block'
                        }
                      }
                      // Clear custom dates when other option is selected
                      customFromDate.value = ''
                      customToDate.value = ''
                      customFromDate.removeAttribute('data-iso-date')
                      customToDate.removeAttribute('data-iso-date')
                    }
                  }
                })
                
                // Hide date inputs in dropdown initially (we'll use modal inputs instead)
                setTimeout(() => {
                  const styledRef = window.reportDateFilter_styled
                  if (styledRef && styledRef.checkBoxes) {
                    const dropdownDateInputs = styledRef.checkBoxes.querySelector('.date-list:last-of-type')
                    if (dropdownDateInputs) {
                      dropdownDateInputs.style.display = 'none'
                    }
                  }
                }, 150)
                dropdownInitialized = true
              }
            } else {
              dropdownInitialized = true
            }
          }, 100)
        }
      })

      // Close modal handlers
      function closeModal() {
        downloadModal.style.display = 'none'
        // Reset custom date inputs when closing
        customDateInputs.style.display = 'none'
        customFromDate.value = ''
        customToDate.value = ''
        customFromDate.removeAttribute('data-iso-date')
        customToDate.removeAttribute('data-iso-date')
      }

      closeModalBtn.addEventListener('click', closeModal)
      cancelBtn.addEventListener('click', closeModal)

      // Close on backdrop click
      downloadModal.addEventListener('click', function(e) {
        if (e.target === downloadModal) {
          closeModal()
        }
      })

      // Submit download
      submitBtn.addEventListener('click', function() {
        // Get date filter data using reusable function
        const filterResult = getDateFilterData();
        
        if (!filterResult.isValid) {
          showNotification(filterResult.error , "error");
          return;
        }

        // Set loading state using reusable function
        setButtonLoading(submitBtn, true, 'Generating...');

        // Build URL with query parameters using reusable function
        const downloadUrl = buildDateFilterUrl(urls.create_pdf, filterResult.data);

        // Open PDF in new tab
        try {
          window.open(downloadUrl, '_blank');
          
          // Close modal after short delay
          setTimeout(() => {
            closeModal();
            setButtonLoading(submitBtn, false);
          }, 500);
        } catch (error) {
          showNotification(error, "error");
          setButtonLoading(submitBtn, false);
        }
      })

      // Send PDF Statement button handler
      const sendPdfBtn = document.getElementById('send_pdf_statement')
      
      sendPdfBtn.addEventListener('click', async function() {
        // Get date filter data using reusable function
        const filterResult = getDateFilterData();
        
        if (!filterResult.isValid) {
          showNotification(`⚠️ ${filterResult.error}` , "error")
          return;
        }

        /* ============================================================================
         * CLIENT-SIDE VALIDATION (UX ONLY - NOT SECURITY)
         * ============================================================================
         * IMPORTANT: This validation improves user experience but provides ZERO security.
         * 
         * WHY CLIENT-SIDE VALIDATION IS INSUFFICIENT:
         * 1. Easily Bypassed: Users can disable JavaScript or modify it in DevTools
         * 2. No Trust Boundary: Client code runs on user's machine (untrusted environment)
         * 3. API Vulnerability: Direct API calls bypass all client-side checks
         * 4. Browser Tools: Tools like Postman/curl can send any data directly
         * 
         * SECURITY RISKS OF TRUSTING CLIENT-PROVIDED DATES:
         * 1. Data Exfiltration: Attacker requests date range covering entire database
         *    Example: from_date='1900-01-01', to_date='2099-12-31'
         * 2. Performance DoS: Massive date ranges cause expensive database queries
         *    Example: 100-year range on millions of records = server timeout
         * 3. Privacy Violation: Access to data outside authorized time period
         *    Example: Employee requests future dates to see unreleased financial data
         * 4. SQL Injection: Malformed dates could exploit poor server validation
         *    Example: from_date="2024-01-01' OR '1'='1" (if not using parameterized queries)
         * 
         * EXAMPLE MALICIOUS ATTACK:
         * Attacker opens DevTools console and runs:
         *   fetch('/report/send-pdf-statement/230/', {
         *     method: 'POST',
         *     headers: {'Content-Type': 'application/json', 'X-CSRFToken': 'token'},
         *     body: JSON.stringify({
         *       date_filter: 'custom',
         *       from_date: '1900-01-01',  // Entire history
         *       to_date: '2099-12-31',    // Far future
         *     })
         *   })
         * Result: Server generates massive PDF with all customer data, sends via WhatsApp
         * 
         * REQUIRED SERVER-SIDE VALIDATIONS (Django View):
         * See implementation example below this validation block.
         * ============================================================================
         */

        // Set loading state using reusable function
        setButtonLoading(sendPdfBtn, true, 'Sending...');

        // Build URL with query parameters using reusable function
        const sendUrl = buildDateFilterUrl(urls.send_pdf, filterResult.data);

        try {
          const response = await fetch(sendUrl, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          // Handle response using reusable function
          const data = await handleFetchResponse(response);

          // Success handling
          if (data.success || data.status === 'success') {
            showNotification('✅ PDF statement sent successfully via WhatsApp!', 'success');
            
            setTimeout(() => {
              closeModal();
            }, 500);
          } else {
            throw new Error(data.error || data.message || 'Unexpected response from server');
          }
        } catch (error) {
          showNotification('send PDF statement', error);
        } finally {
          setButtonLoading(sendPdfBtn, false);
        }
      })
    })

    // Global function - must be outside DOMContentLoaded to be accessible from dynamically loaded HTML
    async function send_credit_payment(id) {
      try {
        const response = await fetch(`/report/send-text/${id}/`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        // Handle response using reusable function
        const data = await handleFetchResponse(response);

        // Success handling
        if (data.success || data.status === 'success') {
          showNotification('✅ Payment sent successfully via WhatsApp!', 'success');
        } else {
          throw new Error(data.error || data.message || 'Unexpected response from server');
        }
      } catch (error) {
        showNotification('send payment', error);
      }
    }

    
    function confirmAutoReallocate() {
      const confirmed = confirm('⚠️ WARNING: This action will:\n\n' + '• Delete ALL existing payment allocations\n' + '• Reapply payments using FIFO method (oldest invoices first)\n' + '• This action cannot be undone\n\n' + 'Are you sure you want to continue?')
    
      if (confirmed) {
        const btn = document.getElementById('autoReallocateBtn')
        const originalText = btn.innerHTML
        const originalClass = btn.className
    
        // Show loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reallocating...'
        btn.className = 'btn btn-warning disabled'
        btn.style.pointerEvents = 'none'
    
        // Re-enable after a short delay (in case of errors)
        setTimeout(() => {
          btn.innerHTML = originalText
          btn.className = originalClass
          btn.style.pointerEvents = 'auto'
        }, 10000)
    
        return true
      }
    
      return false
    }
  </script>
{% endblock extra_js %}
