{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}
  {{ supplier.name }} - Transaction Report
{% endblock title %}
{% block content %}
  <!-- Page Header -->
  <div class="page-header">
    <h2 class="page-title">{{ supplier.name }} - Transaction Report</h2>
    <div class="page-actions">
      <!-- Date Filter Dropdown -->
      <form method="get" class="d-inline" id="dateFilterForm">
        <select name="date_filter" class="form-select" id="dateFilter">
          <option value="this_month" >This Month</option>
          <option value="last_month" >Last Month</option>
          <option value="this_quarter" >This Quarter</option>
          <option value="last_quarter" >Last Quarter</option>
          <option value="this_finance" >This Finance</option>
          <option value="last_finance" >Last Finance</option>
          <option value="full_date" >Full Date</option>
        </select>
      </form>
      <button type="button" class="btn btn-info" id="downloadReportBtn">
        <i class="fas fa-download"></i>
        Download Report
      </button>
      <a href="{% url 'supplier:detail' supplier.pk %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i>
        Back
      </a>
    </div>
  </div>
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb breadcrumb-right">
    <a href="{% url 'base:home' %}" class="breadcrumb-item">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'supplier:home' %}" class="breadcrumb-item">Suppliers</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'supplier:detail' supplier.pk %}"
       class="breadcrumb-item">{{ supplier.name }}</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-active">Report</span>
  </nav>
  <!-- Main Layout -->
  <div class="col d-flex flex-row">
    <!-- Left Column - Supplier Details and Summary -->
    <div class="col-md-2 d-flex flex-column gap-2">
      <!-- Supplier Details Column -->
      <div class="column details-column">
        <div class="column-header">
          <h3>
            <i class="fas fa-user"></i> Supplier Details
          </h3>
        </div>
        <div class="details-info-compact">
          <div class="detail-name-compact">
            <h4>{{ supplier.name }}</h4>
            <span class="detail-status {% if not supplier.is_deleted %}status-active{% else %}status-inactive{% endif %}">
              {% if supplier.is_deleted %}
                Inactive
              {% else %}
                Active
              {% endif %}
            </span>
          </div>
          <div class="detail-contact-compact">
            {% if supplier.phone %}
              <div class="contact-item">
                <i class="fas fa-phone"></i>
                <span>{{ supplier.phone }}</span>
              </div>
            {% endif %}
            {% if supplier.email %}
              <div class="contact-item">
                <i class="fas fa-envelope"></i>
                <span>{{ supplier.email }}</span>
              </div>
            {% endif %}
            {% if supplier.contact_person %}
              <div class="contact-item">
                <i class="fas fa-user"></i>
                <span>{{ supplier.contact_person }}</span>
              </div>
            {% endif %}
            {% if supplier.gstin %}
              <div class="contact-item">
                <i class="fas fa-id-card"></i>
                <span>{{ supplier.gstin }}</span>
              </div>
            {% endif %}
            {% if supplier.address %}
              <div class="contact-item">
                <i class="fas fa-map-marker-alt"></i>
                <span>{{ supplier.address|truncatechars:50 }}</span>
              </div>
            {% endif %}
            <div class="contact-item">
              <i class="fas fa-calendar"></i>
              <span>{{ supplier.created_at|date:"M d, Y" }}</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Summary Cards -->
      <div class="summary-card-compact" id="supplierSummaryCard">
        <div class="summary-icon-compact">
          <i class="fas fa-file-invoice"></i>
        </div>
        <div class="summary-content-compact">
          <h4>Amounts</h4>
          <div class="summary-stats-compact">
            <div class="stat-item-compact">
              <span class="stat-number-compact" id="totalInvoiced">0</span>
              <span class="stat-label-compact">Total Invoiced</span>
            </div>
            <div class="stat-item-compact">
              <span class="stat-number-compact text-success" id="totalPaid">0</span>
              <span class="stat-label-compact">Total Paid</span>
            </div>
            <div class="stat-item-compact">
              <span class="stat-number-compact" id="outstandingBalance">0</span>
              <span class="stat-label-compact">Outstanding</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Transaction Summary Card -->
      <div class="summary-card-compact" id="transactionSummaryCard">
        <div class="summary-icon-compact">
          <i class="fas fa-list"></i>
        </div>
        <div class="summary-content-compact">
          <h4>Transactions</h4>
          <div class="summary-stats-compact">
            <div class="stat-item-compact">
              <span class="stat-number-compact" id="transactionCount">0</span>
              <span class="stat-label-compact">Total Count</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Right Column - Transaction Table -->
    <div class="col-md-10 d-flex flex-column gap-2 ps-1">
      <!-- Transaction Table -->
      <div class="table-section" id="reportSection">
        <div class="table-header">
          <h3>
            <i class="fas fa-file-invoice-dollar"></i> Transaction History
          </h3>
        </div>
        <div class="table-container">
          <table class="data-table" id="report_table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Reference</th>
                <th>Description</th>
                <th class="text-right">Credit</th>
                <th class="text-right">Debit</th>
                <th class="text-right">Running Balance</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="report_table_body">
              <tr>
                <td colspan="8" class="text-center p-4">
                  <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    Loading transactions...
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}

{% block extra_js %}
  <script src="{% static 'js/fetchData.js' %}"></script>
  <!-- Visual Select to Styled Dropdown Converter -->
  <script src="{% static 'js/dropdown_style.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Summary card click handlers
      const supplierSummaryCard = document.getElementById('supplierSummaryCard')
      const transactionSummaryCard = document.getElementById('transactionSummaryCard')
      const reportSection = document.getElementById('reportSection')
    
      supplierSummaryCard.addEventListener('click', function () {
        reportSection.scrollIntoView({ behavior: 'smooth' })
      })
    
      transactionSummaryCard.addEventListener('click', function () {
        reportSection.scrollIntoView({ behavior: 'smooth' })
      })

      // Initialize AJAX table
      const urls = {
        report: '{% url "supplier:report_fetch" supplier.pk %}',
        download_pdf: '{% url "report:supplier_ind_pdf" supplier.pk %}'
      }


      // Custom table loader that handles the backend-rendered HTML
      async function loadReportTable(tableId, fetchUrl) {
        const table = document.getElementById(tableId)
        const tbody = table.querySelector('tbody')
        
        if (!table || !tbody) {
          console.error('Table elements not found')
          return
        }

        // Show loading state
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="text-center p-4">
              <div class="loading">
                <i class="fas fa-spinner fa-spin"></i>
                Loading transactions...
              </div>
            </td>
          </tr>
        `

        try {
          // Get date filter value from styled dropdown or regular select
          const styledRef = window.dateFilter_styled
          const dateFilter = styledRef?.hiddenSelect || document.getElementById('dateFilter') || document.getElementById('dateFilter_hidden')
          const dateFilterValue = dateFilter ? dateFilter.value : 'this_month'

          // Build URL with query parameters
          const params = new URLSearchParams({
            date_filter: dateFilterValue
          })

          // If custom date, add from_date and to_date parameters
          if (dateFilterValue === 'custom' && dateFilter) {
            const fromDate = dateFilter.getAttribute('data-from-date')
            const toDate = dateFilter.getAttribute('data-to-date')
            if (fromDate) params.append('from_date', fromDate)
            if (toDate) params.append('to_date', toDate)
          }

          const url = `${fetchUrl}?${params.toString()}`

          const response = await fetch(url)
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`)
          
          const data = await response.json()
          if (!data.success) throw new Error(data.error || 'Failed to load')

          // Update summary cards
          const totalInvoiced = document.getElementById('totalInvoiced')
          const totalPaid = document.getElementById('totalPaid')
          const outstandingBalance = document.getElementById('outstandingBalance')
          const transactionCount = document.getElementById('transactionCount')

          if (totalInvoiced) totalInvoiced.textContent = formatCurrency(data.total_invoiced)
          if (totalPaid) totalPaid.textContent = formatCurrency(data.total_paid)
          if (transactionCount) transactionCount.textContent = data.transaction_count || 0

          if (outstandingBalance) {
            outstandingBalance.textContent = formatCurrency(data.outstanding_balance)
            outstandingBalance.className = 'stat-number-compact ' + (data.outstanding_balance > 0 ? 'text-danger' : 'text-success')
          }

          // Insert table HTML from backend
          if (data.table_html) {
            tbody.innerHTML = data.table_html
          } else {
            throw new Error('No table HTML received')
          }

        } catch (error) {
          console.error('Error loading report:', error)
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center p-4">
                <div class="error-state">
                  <i class="fas fa-exclamation-triangle"></i>
                  <p>Failed to load transactions. Please try again.</p>
                </div>
              </td>
            </tr>
          `
        }
      }

      // Initialize styled dropdown for date filter
      const currentFilter = '{{ date_filter|default:"this_month" }}'
      
      if (typeof convertSelectToStyledDropdown !== 'undefined') {
        setTimeout(() => {
          const dateFilterSelect = document.getElementById('dateFilter')
          if (dateFilterSelect && !window.dateFilter_styled) {
            convertSelectToStyledDropdown('dateFilter', {
              onChange: function(data) {
                // Store custom dates in data attributes for later retrieval
                if (data.value === 'custom' && data.fromDate && data.toDate) {
                  const styledRef = window.dateFilter_styled
                  const hiddenSelect = styledRef?.hiddenSelect
                  if (hiddenSelect) {
                    hiddenSelect.setAttribute('data-from-date', data.fromDate)
                    hiddenSelect.setAttribute('data-to-date', data.toDate)
                  }
                }
                loadReportTable('report_table', urls.report)
              }
            })
          }
        }, 100)
      }

      // Download Report function
      function downloadReport() {
        // Get date filter value from styled dropdown or regular select
        const styledRef = window.dateFilter_styled
        const dateFilter = styledRef?.hiddenSelect || document.getElementById('dateFilter') || document.getElementById('dateFilter_hidden')
        const dateFilterValue = dateFilter ? dateFilter.value : 'this_month'

        // Build URL with query parameters
        const params = new URLSearchParams({
          date_filter: dateFilterValue
        })

        // If custom date, add from_date and to_date parameters
        if (dateFilterValue === 'custom' && dateFilter) {
          const fromDate = dateFilter.getAttribute('data-from-date')
          const toDate = dateFilter.getAttribute('data-to-date')
          if (fromDate) params.append('from_date', fromDate)
          if (toDate) params.append('to_date', toDate)
        }

        // Build download URL
        const downloadUrl = `${urls.download_pdf}?${params.toString()}`

        // Open PDF in new tab
        window.open(downloadUrl, '_blank')
      }

      // Download report button handler
      const downloadReportBtn = document.getElementById('downloadReportBtn')
      if (downloadReportBtn) {
        downloadReportBtn.addEventListener('click', downloadReport)
      }

      // Load table on page load
      loadReportTable('report_table', urls.report)
    })
  </script>
{% endblock extra_js %}
