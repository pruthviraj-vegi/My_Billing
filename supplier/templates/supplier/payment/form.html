{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}
  {{ title }} - {{ supplier.name }}
{% endblock title %}
{% block content %}
  <!-- Page Header -->
  <div class="page-header">
    <h2 class="page-title">{{ title }}</h2>
    <div class="page-actions">
      <a href="{% url 'supplier:detail' supplier.pk %}"
         class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i>
        Back to Supplier
      </a>
    </div>
  </div>
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb breadcrumb-right">
    <a href="{% url 'base:home' %}" class="breadcrumb-item">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'supplier:home' %}" class="breadcrumb-item">Suppliers</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'supplier:detail' supplier.pk %}"
       class="breadcrumb-item">{{ supplier.name }}</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-active">{{ title }}</span>
  </nav>
  <!-- Supplier Payment Form -->
  <div class="form-container col-md-6">
    <div class="form-card">
      <!-- Supplier Info Summary -->
      <div class="info-summary">
        <h4>{{ supplier.name }}</h4>
        <p>
          {% if supplier.contact_person %}{{ supplier.contact_person }} •{% endif %}
          {{ supplier.phone }}
          {% if supplier.email %}• {{ supplier.email }}{% endif %}
        </p>
      </div>
      
      <!-- Payment Form -->
      <form method="post" class="details-form" novalidate autocomplete="off" id="paymentForm">
        {% csrf_token %}
        <!-- Payment Details Section -->
        <div class="form-section">
          <h5 class="section-title">Payment Details : {{supplier.balance_due|currency}}</h5>
          <div class="row">
            <div class="form-group {% if form.amount.errors %}has-error{% endif %}">
              <label for="{{ form.amount.id_for_label }}" class="form-label">{{ form.amount.label }}</label>
              {{ form.amount }}
              <small class="form-help">
                {% if form.amount.errors %}
                  {% for error in form.amount.errors %}
                    {% if 'Cannot reduce payment amount below total allocated amount' in error %}
                      <div class="amount-error-message">
                        <div class="error-header">
                          <i class="fas fa-exclamation-triangle"></i>
                          <span>Payment Amount Error</span>
                        </div>
                        <div class="error-body">{{ error }}</div>
                        <div class="error-solution">
                          <strong>Solution:</strong> First delete or reduce the allocations for this payment, then you can reduce the payment amount.
                        </div>
                      </div>
                    {% else %}
                      <span class="form-error-inline">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ error }}
                      </span>
                    {% endif %}
                  {% endfor %}
                {% endif %}
                <span class="form-help-text">Enter the amount of the payment</span>
              </small>
            </div>
          </div>
          <div class="row">
            <div class="form-group {% if form.method.errors %}has-error{% endif %}">
              <label for="{{ form.method.id_for_label }}" class="form-label">{{ form.method.label }}</label>
              {{ form.method }}
              <small class="form-help">
                {% if form.method.errors %}
                  {% for error in form.method.errors %}
                    <span class="form-error-inline">
                      <i class="fas fa-exclamation-circle"></i>
                      {{ error }}
                    </span>
                  {% endfor %}
                {% endif %}
                <span class="form-help-text">Select the method of the payment</span>
              </small>
            </div>
          </div>
          <div class="row">
            <div class="form-group {% if form.payment_date.errors %}has-error{% endif %}">
              <label for="{{ form.payment_date.id_for_label }}" class="form-label">{{ form.payment_date.label }}</label>
              {{ form.payment_date }}
              <small class="form-help">
                {% if form.payment_date.errors %}
                  {% for error in form.payment_date.errors %}
                    <span class="form-error-inline">
                      <i class="fas fa-exclamation-circle"></i>
                      {{ error }}
                    </span>
                  {% endfor %}
                {% endif %}
                <span class="form-help-text">Select the date of the payment</span>
              </small>
            </div>
          </div>
          <div class="row">
            <div class="form-group {% if form.transaction_id.errors %}has-error{% endif %}">
              <label for="{{ form.transaction_id.id_for_label }}" class="form-label">{{ form.transaction_id.label }}</label>
              {{ form.transaction_id }}
              <small class="form-help">
                {% if form.transaction_id.errors %}
                  {% for error in form.transaction_id.errors %}
                    <span class="form-error-inline">
                      <i class="fas fa-exclamation-circle"></i>
                      {{ error }}
                    </span>
                  {% endfor %}
                {% endif %}
                <span class="form-help-text">Required for Bank Transfer and UPI payments</span>
              </small>
            </div>
          </div>
        </div>
        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i>
            {% if payment %}
              Update Payment
            {% else %}
              Create Payment
            {% endif %}
          </button>
          <a href="{% url 'supplier:detail' supplier.pk %}"
             class="btn btn-secondary">
            <i class="fas fa-times"></i>
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
{% endblock content %}
{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const methodSelect = document.getElementById('{{ form.method.id_for_label }}')
      const transactionIdField = document.getElementById('{{ form.transaction_id.id_for_label }}')
      const transactionIdLabel = transactionIdField ? document.querySelector(`label[for="{{ form.transaction_id.id_for_label }}"]`) : null
      const amountField = document.getElementById('{{ form.amount.id_for_label }}')
    
      function toggleTransactionIdRequired() {
        const selectedMethod = methodSelect.value
        const formGroup = transactionIdField ? transactionIdField.closest('.form-group') : null
        const helpText = formGroup ? formGroup.querySelector('.form-help-text') : null
        
        if (selectedMethod === 'BANK_TRANSFER' || selectedMethod === 'UPI') {
          if (transactionIdField) transactionIdField.required = true
          if (transactionIdLabel && !transactionIdLabel.textContent.includes('*')) {
            transactionIdLabel.textContent = transactionIdLabel.textContent + ' *'
          }
          if (helpText) helpText.style.display = 'block'
        } else {
          if (transactionIdField) transactionIdField.required = false
          if (transactionIdLabel) {
            transactionIdLabel.textContent = transactionIdLabel.textContent.replace(' *', '').trim()
          }
          if (helpText) helpText.style.display = 'none'
        }
      }
    
      // Initial setup
      toggleTransactionIdRequired()
    
      // Listen for changes
      methodSelect.addEventListener('change', toggleTransactionIdRequired)
      
      // Handle amount field errors
      {% if form.amount.errors %}
        // Focus on amount field if there are errors
        if (amountField) {
          amountField.focus()
          amountField.scrollIntoView({ behavior: 'smooth', block: 'center' })
          
          // Add pulsing animation to error message
          const errorMessage = document.querySelector('.amount-error-message')
          if (errorMessage) {
            errorMessage.style.animation = 'pulse 2s infinite'
          }
        }
      {% endif %}
      
      // Clear error highlighting when user starts typing
      if (amountField) {
        amountField.addEventListener('input', function() {
          this.classList.remove('error-highlight')
        })
      }
    })
  </script>
{% endblock extra_js %}
