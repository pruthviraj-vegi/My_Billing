{% extends "base.html" %}
{% load static %}
{% block title %}
  {{ title }} - {{ supplier.name }}
{% endblock title %}
{% block content %}
  <!-- Page Header -->
  <div class="page-header">
    <h2 class="page-title">{{ title }}</h2>
    <div class="page-actions">
      <a href="{% url 'supplier:detail' supplier.pk %}"
         class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i>
        Back to Supplier
      </a>
    </div>
  </div>
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb breadcrumb-right">
    <a href="{% url 'base:home' %}" class="breadcrumb-item">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'supplier:home' %}" class="breadcrumb-item">Suppliers</a>
    <span class="breadcrumb-separator">/</span>
    <a href="{% url 'supplier:detail' supplier.pk %}"
       class="breadcrumb-item">{{ supplier.name }}</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-active">{{ title }}</span>
  </nav>
  <!-- Supplier Payment Form -->
  <div class="form-container col-md-6">
    <div class="form-card">
      <!-- Supplier Info Summary -->
      <div class="info-summary">
        <h4>{{ supplier.name }}</h4>
        <p>
          {% if supplier.contact_person %}{{ supplier.contact_person }} •{% endif %}
          {{ supplier.phone }}
          {% if supplier.email %}• {{ supplier.email }}{% endif %}
        </p>
      </div>
      <!-- Allocation Warning -->
      {% if has_allocations %}
        <div class="alert alert-warning">
          <div class="alert-header">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Payment Has Allocations</strong>
          </div>
          <div class="alert-body">
            <p>
              This payment has ₹{{ total_allocated|floatformat:2 }} allocated to invoices. You cannot reduce the payment amount below this allocated amount.
            </p>
            <p>
              <strong>Minimum allowed amount: ₹{{ total_allocated|floatformat:2 }}</strong>
            </p>
          </div>
        </div>
      {% endif %}
      <!-- Payment Form -->
      <form method="post" class="details-form">
        {% csrf_token %}
        <!-- Payment Details Section -->
        <div class="form-section">
          <h5 class="section-title">Payment Details</h5>
          <div class="row">
            <div class="form-group">
              <label for="{{ form.amount.id_for_label }}" class="form-label">Amount *</label>
              {{ form.amount }} <small class="form-help">Enter the amount of the payment</small>
              {% if form.amount.errors %}
                {% for error in form.amount.errors %}
                  {% if 'Cannot reduce payment amount below total allocated amount' in error %}
                    <div class="amount-error-message">
                      <div class="error-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Payment Amount Error</span>
                      </div>
                      <div class="error-body">{{ error }}</div>
                      <div class="error-solution">
                        <strong>Solution:</strong> First delete or reduce the allocations for this payment, then you can reduce the payment amount.
                      </div>
                    </div>
                  {% else %}
                    <div class="field-errors">
                      <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ error }}
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              {% endif %}
            </div>
          </div>
          <div class="row">
            <div class="form-group">
              <label for="{{ form.method.id_for_label }}" class="form-label">Payment Method *</label>
              {{ form.method }} <small class="form-help">Select the method of the payment</small>
              {% if form.method.errors %}
                <div class="field-errors">
                  {% for error in form.method.errors %}
                    <div class="error-message">
                      <i class="fas fa-exclamation-circle"></i>
                      {{ error }}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
          <div class="row">
            <div class="form-group">
              <label for="{{ form.payment_date.id_for_label }}" class="form-label">Payment Date *</label>
              {{ form.payment_date }} <small class="form-help">Select the date of the payment</small>
              {% if form.payment_date.errors %}
                <div class="field-errors">
                  {% for error in form.payment_date.errors %}
                    <div class="error-message">
                      <i class="fas fa-exclamation-circle"></i>
                      {{ error }}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
          <div class="row">
            <div class="form-group">
              <label for="{{ form.transaction_id.id_for_label }}" class="form-label">Transaction ID</label>
              {{ form.transaction_id }} <small class="form-help">Required for Bank Transfer and UPI payments</small>
              {% if form.transaction_id.errors %}
                <div class="field-errors">
                  {% for error in form.transaction_id.errors %}
                    <div class="error-message">
                      <i class="fas fa-exclamation-circle"></i>
                      {{ error }}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
          <div class="form-group">
            <label for="{{ form.notes.id_for_label }}" class="form-label">{{ form.notes.label }}</label>
            {{ form.notes }} <small class="form-help">Enter the notes of the payment</small>
            {% if form.notes.errors %}
              <div class="field-errors">
                {% for error in form.notes.errors %}
                  <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    {{ error }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i>
            {% if payment %}
              Update Payment
            {% else %}
              Create Payment
            {% endif %}
          </button>
          <a href="{% url 'supplier:detail' supplier.pk %}"
             class="btn btn-secondary">
            <i class="fas fa-times"></i>
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
{% endblock content %}
{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const methodSelect = document.getElementById('{{ form.method.id_for_label }}')
      const transactionIdField = document.getElementById('{{ form.transaction_id.id_for_label }}')
      const transactionIdLabel = transactionIdField.previousElementSibling
      const amountField = document.getElementById('{{ form.amount.id_for_label }}')
    
      function toggleTransactionIdRequired() {
        const selectedMethod = methodSelect.value
        if (selectedMethod === 'BANK_TRANSFER' || selectedMethod === 'UPI') {
          transactionIdField.required = true
          transactionIdLabel.innerHTML = 'Transaction ID *'
          transactionIdField.parentElement.querySelector('.form-help').style.display = 'block'
        } else {
          transactionIdField.required = false
          transactionIdLabel.innerHTML = 'Transaction ID'
          transactionIdField.parentElement.querySelector('.form-help').style.display = 'none'
        }
      }
    
      // Initial setup
      toggleTransactionIdRequired()
    
      // Listen for changes
      methodSelect.addEventListener('change', toggleTransactionIdRequired)
      
      // Handle amount field errors
      {% if form.amount.errors %}
        // Focus on amount field if there are errors
        if (amountField) {
          amountField.focus()
          amountField.scrollIntoView({ behavior: 'smooth', block: 'center' })
          
          // Add pulsing animation to error message
          const errorMessage = document.querySelector('.amount-error-message')
          if (errorMessage) {
            errorMessage.style.animation = 'pulse 2s infinite'
          }
        }
      {% endif %}
      
      // Clear error highlighting when user starts typing
      if (amountField) {
        amountField.addEventListener('input', function() {
          this.classList.remove('error-highlight')
        })
      }
    })
  </script>
{% endblock extra_js %}
