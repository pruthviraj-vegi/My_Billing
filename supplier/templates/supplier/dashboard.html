{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}Supplier Dashboard{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/dashboard-charts.css' %}">
{% endblock extra_css %}
{% block content %}
    <!-- Page Header -->
    <div class="page-header page-header-sticky">
        <h2 class="page-title">Supplier Dashboard</h2>
        <div class="page-actions">
            <!-- Date Filter Dropdown -->
            <form method="get" class="d-inline" id="dateFilterForm">
                <select name="date_filter" class="form-select" id="dateFilter">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="this_month">This Month</option>
                    <option value="last_month">Last Month</option>
                    <option value="this_finance">This Finance</option>
                    <option value="last_finance">Last Finance</option>
                    <option value="this_quarter">This Quarter</option>
                    <option value="last_quarter">Last Quarter</option>
                    <option value="full_date">Full Date</option>
                </select>
            </form>
            <a href="{% url 'supplier:home' %}" class="btn">
                <i class="fas fa-list"></i>
                View All Suppliers
            </a>
        </div>
    </div>
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb breadcrumb-right">
        <a href="{% url 'base:home' %}" class="breadcrumb-item">Dashboard</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-active">Supplier Dashboard</span>
    </nav>
    <!-- Loading State - Hidden for seamless updates -->
    <div id="dashboardLoading" class="loading-container hidden">
        <div class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            Loading dashboard data...
        </div>
    </div>
    <!-- Dashboard Content -->
    <div id="dashboardContent" class="dashboardContent">
        <!-- Quick Stats -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number counting-number"
                        id="totalOutstanding"
                        data-count="0">0</h3>
                    <p class="stat-label">Total Outstanding</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number counting-number"
                        id="totalSuppliers"
                        data-count="0">0</h3>
                    <p class="stat-label">Total Suppliers</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-file-invoice"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number counting-number" id="totalInvoices" data-count="0">0</h3>
                    <p class="stat-label">Total Invoices</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-rupee-sign"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number counting-number" id="totalInvoiced" data-count="0">0</h3>
                    <p class="stat-label">Total Invoiced</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number counting-number" id="totalPaid" data-count="0">0</h3>
                    <p class="stat-label">Total Paid</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number counting-number"
                        id="outstandingBalance"
                        data-count="0">0</h3>
                    <p class="stat-label">Outstanding Balance</p>
                </div>
            </div>
        </div>
        <!-- Payment Analytics -->
        <div class="activity-section">
            <h2 class="section-title">Payment Analytics</h2>
            <!-- Payment Status Breakdown -->
            <!-- Payment Status Breakdown -->
            <div class="breakdown-grid">
                <!-- Invoice Status -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Invoice Status</h3>
                    </div>
                    <div class="payment-chart-wrapper">
                        <div class="payment-chart-container">
                            <canvas id="invoiceStatusChart"></canvas>
                        </div>
                        <div id="invoiceStatusLegend" class="custom-legend"></div>
                    </div>
                </div>
                <!-- Supplier Purchases -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Top Suppliers</h3>
                    </div>
                    <div class="payment-chart-wrapper">
                        <div class="payment-chart-container">
                            <canvas id="supplierChart"></canvas>
                        </div>
                        <div id="supplierLegend" class="custom-legend"></div>
                    </div>
                </div>
                <!-- Invoice Type -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Invoice Type</h3>
                    </div>
                    <div class="payment-chart-wrapper">
                        <div class="payment-chart-container">
                            <canvas id="invoiceTypeChart"></canvas>
                        </div>
                        <div id="invoiceTypeLegend" class="custom-legend"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Revenue Comparison Chart -->
        <div class="activity-section">
            <h2 class="section-title">Purchase Comparison</h2>
            <div class="chart-card revenue-chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Purchase Analytics</h3>
                    <div class="chart-summary-stats">
                        <div class="stat-item">
                            <span class="stat-label-small"><span class="legend-dot" style="background: var(--primary);"></span>Current</span>
                            <span class="stat-value-small" id="revCurrentTotal">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label-small"><span class="legend-dot" style="background: var(--secondary);"></span>Previous</span>
                            <span class="stat-value-small" id="revPreviousTotal">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label-small">Change</span>
                            <span class="stat-change" id="revChange">--</span>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="comparisonChart"></canvas>
                </div>
            </div>
        </div>
        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2 class="section-title">Quick Actions</h2>
            <div class="actions-grid">
                <a href="{% url 'supplier:home' %}" class="action-card">
                    <i class="fas fa-list"></i>
                    <span>View All Suppliers</span>
                </a>
                <a href="{% url 'supplier:create' %}" class="action-card">
                    <i class="fas fa-plus"></i>
                    <span>Add Supplier</span>
                </a>
                <a href="{% url 'supplier:home' %}" class="action-card">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Outstanding Balances</span>
                </a>
                <a href="{% url 'supplier:home' %}" class="action-card">
                    <i class="fas fa-chart-bar"></i>
                    <span>View Reports</span>
                </a>
            </div>
        </div>
    </div>
    <!-- Error State -->
    <div id="dashboardError" class="error-container hidden">
        <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Failed to load dashboard data</h3>
            <p>Please try again or contact support if the problem persists.</p>
            <button type="button" class="btn btn-primary" id="retryDashboardBtn">
                <i class="fas fa-refresh"></i>
                Retry
            </button>
        </div>
    </div>
{% endblock content %}
{% block extra_js %}
    <script src="{% static 'assets/plugins/chart/chart-4.5.js' %}"></script>
    <script src="{% static 'js/modern-charts.js' %}"></script>
    <script src="{% static 'js/dropdown_style.js' %}"></script>
    <script src="{% static 'js/counting.js' %}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Charts
        const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
        const statusCtx = document.getElementById('invoiceStatusChart').getContext('2d');
        const supplierCtx = document.getElementById('supplierChart').getContext('2d');
        const typeCtx = document.getElementById('invoiceTypeChart').getContext('2d');
        
        let comparisonChart = ModernCharts.initRevenueChart(comparisonCtx);
        let statusChart = ModernCharts.initDoughnut(statusCtx);
        let supplierChart = ModernCharts.initDoughnut(supplierCtx);
        let typeChart = ModernCharts.initDoughnut(typeCtx);

        updateCount('totalOutstanding', "{{total_outstanding}}");
        updateCount('totalSuppliers', "{{total_suppliers}}");
        updateCount('totalInvoices', "{{total_invoices}}");

        // Fetch Data Function
        async function fetchDashboardData(filter) {
            try {
                // Don't block the UI
                // document.getElementById('dashboardLoading').style.display = 'flex';
                // document.getElementById('dashboardContent').style.display = 'none';
                document.getElementById('dashboardError').style.display = 'none';
                
                // Subtle loading indication
                document.getElementById('dashboardContent').style.opacity = '0.6';

                const response = await fetch(`{% url "supplier:dashboard_fetch" %}?date_filter=${filter}`);
                const data = await response.json();
                
                if (data.success) {
                    updateDashboard(data);
                    document.getElementById('dashboardContent').style.opacity = '1';
                } else {
                    throw new Error(data.message || 'Failed to fetch data');
                }
            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                document.getElementById('dashboardContent').style.opacity = '1';
                document.getElementById('dashboardError').style.display = 'flex';
            } finally {
                // document.getElementById('dashboardLoading').style.display = 'none';
            }
        }

        function updateDashboard(data) {
            // Update Stats
            updateCount('totalInvoices', data.stats.total_invoices);
            updateCount('totalInvoiced', data.stats.total_invoiced);
            updateCount('totalPaid', data.stats.total_paid);
            updateCount('outstandingBalance', data.stats.outstanding_balance);  
            // Note: totalSuppliers and totalOutstanding are static/server-rendered in the template, 
            // but if the API returned them we could update them here. 
            // The API returns 'outstanding_balance' which is period-based, 
            // while 'total_outstanding' in context is all-time.

            // Update Comparison Chart
            if (data.comparison_data) {
                const { currentData, previousData } = ModernCharts.updateRevenueChart(comparisonChart, data.comparison_data);
                
                // Update Summary Totals
                ModernCharts.updateSummaryStats(currentData, previousData, {
                    current: 'revCurrentTotal',
                    previous: 'revPreviousTotal',
                    change: 'revChange'
                });
            }

            // Update Invoice Status Chart - Using backend-calculated percentages
            ModernCharts.updateDoughnut(
                statusChart, 
                'invoiceStatusLegend', 
                data.payment_status_breakdown, 
                { label: 'payment_status', count: 'count', amount: 'amount', percentage: 'percentage' }
            );

            // Update Supplier Purchases Chart - Using backend-calculated percentages
            ModernCharts.updateDoughnut(
                supplierChart, 
                'supplierLegend', 
                data.supplier_breakdown, 
                { label: 'supplier_name', count: 'count', amount: 'amount', percentage: 'percentage' }
            );

            // Update Invoice Type Chart - Using backend-calculated percentages
            ModernCharts.updateDoughnut(
                typeChart, 
                'invoiceTypeLegend', 
                data.category_breakdown, 
                { label: 'category_name', count: 'count', amount: 'amount', percentage: 'percentage' }
            );
        }

        // Event Listeners
        const dateFilter = document.getElementById('dateFilter');
        if (dateFilter) {
            dateFilter.addEventListener('change', (e) => {
                fetchDashboardData(e.target.value);
            });
        }

        const retryBtn = document.getElementById('retryDashboardBtn');
        if (retryBtn) {
            retryBtn.addEventListener('click', () => {
                document.getElementById('dashboardError').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                fetchDashboardData(dateFilter ? dateFilter.value : 'this_month');
            });
        }

        // Initial Load
        fetchDashboardData('this_month');
    });
    </script>
{% endblock extra_js %}
