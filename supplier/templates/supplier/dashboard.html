{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Supplier Dashboard{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        position: sticky;
        top: var(--navbar-height);
        z-index: 100;
    } 
</style>
{% endblock extra_css %}

{% block content %}
  <!-- Page Header -->
  <div class="page-header">
    <h2 class="page-title">Supplier Dashboard</h2>
    <div class="page-actions">
        <!-- Date Filter Dropdown -->
        <form method="get" class="d-inline" id="dateFilterForm">
            <select name="date_filter" class="form-select" id="dateFilter">
                <option value="this_month">This Month</option>
                <option value="last_month">Last Month</option>
                <option value="this_finance">This Finance</option>
                <option value="last_finance">Last Finance</option>
                <option value="full_date">Full Date</option>
            </select>
        </form>
      <a href="{% url 'supplier:create' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        Add Supplier
      </a>
    </div>
  </div>

  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb breadcrumb-right">
    <a href="{% url 'base:home' %}" class="breadcrumb-item">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-active">Supplier Dashboard</span>
  </nav>

<!-- Loading State - Hidden for seamless updates -->
<div id="dashboardLoading" class="loading-container" style="display: none;">
    <div class="loading">
        <i class="fas fa-spinner fa-spin"></i>
        Loading dashboard data...
    </div>
  </div>

<!-- Dashboard Content -->
<div id="dashboardContent" class="dashboardContent">
    <!-- Quick Stats -->
    <div class="stats-grid" id="statsGrid">

      <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-exclamation-triangle"></i>
      </div>
        <div class="stat-content">
            <h3 class="stat-number" id="totalOutstanding">{{ total_outstanding|currency }}</h3>
            <p class="stat-label">Total Outstanding</p>
      </div>
  </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-content">
                <h3 class="stat-number" id="totalSuppliers">{{ total_suppliers }}</h3>
        <p class="stat-label">Total Suppliers</p>
      </div>
    </div>
        

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-file-invoice"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number" id="totalInvoices">0</h3>
                <p class="stat-label">Total Invoices</p>
            </div>
        </div>

    <div class="stat-card">
      <div class="stat-icon">
                <i class="fas fa-rupee-sign"></i>
      </div>
      <div class="stat-content">
                <h3 class="stat-number" id="totalInvoiced">₹0</h3>
        <p class="stat-label">Total Invoiced</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-credit-card"></i>
      </div>
      <div class="stat-content">
                <h3 class="stat-number" id="totalPaid">₹0</h3>
        <p class="stat-label">Total Paid</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="stat-content">
                <h3 class="stat-number" id="outstandingBalance">₹0</h3>
        <p class="stat-label">Outstanding Balance</p>
      </div>
    </div>
  </div>

    <!-- Payment Analytics -->
  <div class="activity-section">
        <h2 class="section-title">Payment Analytics</h2>
        
        <!-- Payment Status Breakdown -->
        <div class="analytics-grid">
            <div class="analytics-card">
                <h3 class="analytics-title">Invoice Status</h3>
                <div class="analytics-content" id="invoice_status">
                    <div class="chart-container">
                        <canvas id="invoiceStatusChart" width="280" height="180"></canvas>
                    </div>
                    <div class="chart-legend" id="invoiceStatusLegend">
                        <!-- Legend will be populated here -->
                    </div>
                </div>
            </div>

            <div class="analytics-card">
                <h3 class="analytics-title">Invoice Purchased by Supplier</h3>
                <div class="analytics-content" id="supplier_purchases">
                    <div class="chart-container">
                        <canvas id="supplierChart" width="280" height="180"></canvas>
                    </div>
                    <div class="chart-legend" id="supplierLegend">
                        <!-- Legend will be populated here -->
                    </div>
                </div>
            </div>

            <div class="analytics-card">
                <h3 class="analytics-title">Invoice Type</h3>
                <div class="analytics-content" id="invoice_type">
                    <div class="chart-container">
                        <canvas id="invoiceTypeChart" width="280" height="180"></canvas>
                    </div>
                    <div class="chart-legend" id="invoiceTypeLegend">
                        <!-- Legend will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue Comparison Chart -->
    <div class="activity-section">
        <h2 class="section-title">Purchase Comparison</h2>
        <div class="comparison-chart-container" id="comparison_chart">
            <div class="comparison-chart-header">
                <div class="chart-info">
                    <div class="period-info" id="periodInfo">
                        <!-- Period information will be populated here -->
                    </div>
                </div>
            </div>
            <div class="comparison-chart-wrapper">
                <canvas id="comparisonChart" width="800" height="400"></canvas>
            </div>
            <div class="chart-summary" id="chartSummary">
                <!-- Summary statistics will be populated here -->
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <h2 class="section-title">Quick Actions</h2>
        <div class="actions-grid">
            <a href="{% url 'supplier:home' %}" class="action-card">
                <i class="fas fa-list"></i>
                <span>View All Suppliers</span>
            </a>
            <a href="{% url 'supplier:create' %}" class="action-card">
                <i class="fas fa-plus"></i>
                <span>Add Supplier</span>
            </a>
            <a href="{% url 'supplier:home' %}" class="action-card">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Outstanding Balances</span>
            </a>
            <a href="{% url 'supplier:home' %}" class="action-card">
                <i class="fas fa-chart-bar"></i>
                <span>View Reports</span>
            </a>
        </div>
      </div>
        </div>

<!-- Error State -->
<div id="dashboardError" class="error-container" style="display: none;">
    <div class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Failed to load dashboard data</h3>
        <p>Please try again or contact support if the problem persists.</p>
        <button type="button" class="btn btn-primary" onclick="loadDashboardData()">
            <i class="fas fa-refresh"></i>
            Retry
        </button>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<!-- Chart.js Library -->
<script src="{% static 'assets/plugins/chart/chart-4.5.js' %}"></script>
<!-- Chart Utilities - All chart functions in one file -->
<script src="{% static 'js/chart-utils.js' %}"></script>

<script>
    // Supplier Dashboard - Page Specific Code
    (function() {
        const fetchUrl = '{% url "supplier:dashboard_fetch" %}';
        const currentFilter = '{{ date_filter|default:"this_month" }}';

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function updateStats(stats) {
            // Note: totalOutstanding and totalSuppliers are static and set from initial template render
            // They don't change with date filter, so we don't update them here
            const el = document.getElementById('totalInvoices');
            if (el) el.textContent = stats.total_invoices || 0;
            
            const el2 = document.getElementById('totalInvoiced');
            if (el2) el2.textContent = '₹' + formatCurrency(stats.total_invoiced || 0);
            
            const el3 = document.getElementById('totalPaid');
            if (el3) el3.textContent = '₹' + formatCurrency(stats.total_paid || 0);
            
            const el4 = document.getElementById('outstandingBalance');
            if (el4) el4.textContent = '₹' + formatCurrency(stats.outstanding_balance || 0);
        }

        async function loadSupplierDashboard() {
            const dateFilter = document.getElementById('dateFilter');
            const loadingEl = document.getElementById('dashboardLoading');
            const errorEl = document.getElementById('dashboardError');
            
            if (errorEl) errorEl.style.display = 'none';
            if (dateFilter) {
                dateFilter.style.opacity = '0.7';
                dateFilter.disabled = true;
            }

            try {
                const dateFilterValue = dateFilter ? dateFilter.value : currentFilter;
                const params = new URLSearchParams({ date_filter: dateFilterValue });
                const response = await fetch(fetchUrl + '?' + params.toString());
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'Failed to load');

                // Update stats
                updateStats(data.stats);

                // Update charts - just pass data, config is already stored
                if (data.payment_status_breakdown && data.payment_status_breakdown.length) {
                    invoice_status.update({
                        data: data.payment_status_breakdown.map(item => ({
                            label: item.payment_status,
                            value: item.count,
                            amount: item.amount
                        }))
                    });
                }

                if (data.supplier_breakdown && data.supplier_breakdown.length) {
                    supplier_purchases.update({
                        data: data.supplier_breakdown.map(item => ({
                            label: item.supplier_name,
                            value: item.count,
                            amount: item.amount
                        }))
                    });
                }

                if (data.category_breakdown && data.category_breakdown.length) {
                    invoice_type.update({
                        data: data.category_breakdown.map(item => ({
                            label: item.category_name,
                            value: item.count,
                            amount: item.amount
                        }))
                    });
                }

                // Update comparison chart - just pass comparison data, everything handled automatically
                if (data.comparison_data) {
                    comparison_chart.update({
                        comparison_data: data.comparison_data,
                        metric: 'amount'
                    });
                }

            } catch (err) {
                console.error('Dashboard loading error:', err);
                if (errorEl) errorEl.style.display = 'block';
            } finally {
                if (dateFilter) {
                    dateFilter.style.opacity = '1';
                    dateFilter.disabled = false;
                }
            }
        }

        window.addEventListener('DOMContentLoaded', function() {
            // Bind charts to containers - auto-detects canvas and legend, stores config
            Charts.bindChart('invoice_status', {
                key: 'supplier_invoice_status',
                colors: Charts.getColors('blue').colors,
                colorsHover: Charts.getColors('blue').colorsHover
            });
            
            Charts.bindChart('supplier_purchases', {
                key: 'supplier_purchases',
                colors: Charts.getColors('cyan').colors,
                colorsHover: Charts.getColors('cyan').colorsHover
            });
            
            Charts.bindChart('invoice_type', {
                key: 'supplier_invoice_type',
                colors: Charts.getColors('green').colors,
                colorsHover: Charts.getColors('green').colorsHover
            });
            
            // Bind comparison chart (line chart)
            Charts.bindChart('comparison_chart', {
                key: 'supplier_comparison',
                type: 'line',
                options: {
                    formatYAxis: 'amount',
                    gridColor: 'rgba(148, 163, 184, 0.1)',
                    showLegend: false
                }
            });
            
            // Set initial date filter
            const dateFilter = document.getElementById('dateFilter');
            if (dateFilter && currentFilter) {
                dateFilter.value = currentFilter;
            }
            
            // Load initial data
            loadSupplierDashboard();
            
            // Handle date filter change
            if (dateFilter) {
                dateFilter.addEventListener('change', loadSupplierDashboard);
            }
        });
    })();
  </script>
{% endblock extra_js %}
