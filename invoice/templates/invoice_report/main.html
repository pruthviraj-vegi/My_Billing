{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}
  Invoice Report
{% endblock title %}
{% block content %}
  <!-- Page Header -->
  <div class="page-header">
    <h2 class="page-title">Invoice Report</h2>
    <div class="page-actions">
      <!-- Date Filter Dropdown -->
      <form method="get" class="d-inline" id="dateFilterForm">
        <select name="date_filter" class="form-select" id="dateFilter">
          <option value="this_month">This Month</option>
          <option value="last_month">Last Month</option>
          <option value="this_quarter">This Quarter</option>
          <option value="last_quarter">Last Quarter</option>
          <option value="this_finance">This Finance</option>
          <option value="last_finance">Last Finance</option>
          <option value="full_date">Full Date</option>
        </select>
      </form>
      <button type="button" class="btn btn-info" id="downloadReportBtn">
        <i class="fas fa-download"></i>
        Download Report
      </button>
    </div>
  </div>
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb breadcrumb-right">
    <a href="{% url 'base:home' %}" class="breadcrumb-item">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-active">Invoice Report</span>
  </nav>
  <!-- Main Layout -->
  <div class="col">
    <!-- Invoice Table -->
    <div class="col-md-12 d-flex flex-column gap-2 ps-1">
      <div class="table-section" id="reportSection">
        <div class="table-header">
          <h3>
            <i class="fas fa-file-invoice-dollar"></i> Invoice Report
          </h3>
        </div>
        <div class="table-container">
          <table class="data-table" id="report_table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Invoice Number</th>
                <th>Customer</th>
                <th>Invoice Type</th>
                <th>Net Amount</th>
                <th>CGST</th>
                <th>SGST</th>
                <th>IGST</th>
                <th>Total Gst</th>
                <th>Total Amount</th>
              </tr>
            </thead>
            <tbody id="report_table_body">
              <tr>
                <td colspan="10" class="text-center p-4">
                  <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    Loading transactions...
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-12 d-flex flex-column gap-2 ps-1">
      <div class="table-section" id="cancled_reportSection">
        <div class="table-header">
          <h3>
            <i class="fas fa-file-invoice-dollar"></i> Cancelled Invoice Report
          </h3>
        </div>
        <div class="table-container">
          <table class="data-table" id="cancled_report_table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Invoice Number</th>
                <th>Customer</th>
                <th>Invoice Type</th>
                <th>Net Amount</th>
                <th>CGST</th>
                <th>SGST</th>
                <th>IGST</th>
                <th>Total Gst</th>
                <th>Total Amount</th>
              </tr>
            </thead>
            <tbody id="cancled_report_table_body">
              <tr>
                <td colspan="10" class="text-center p-4">
                  <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    Loading transactions...
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-12 d-flex flex-column gap-2 ps-1">
      <div class="table-section" id="return_reportSection">
        <div class="table-header">
          <h3>
            <i class="fas fa-file-invoice-dollar"></i> Return Invoice Report
          </h3>
        </div>
        <div class="table-container">
          <table class="data-table" id="return_report_table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Invoice Number</th>
                <th>Customer</th>
                <th>Invoice Type</th>
                <th>Net Amount</th>
                <th>CGST</th>
                <th>SGST</th>
                <th>IGST</th>
                <th>Total Gst</th>
                <th>Total Amount</th>
              </tr>
            </thead>
            <tbody id="return_report_table_body">
              <tr>
                <td colspan="10" class="text-center p-4">
                  <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    Loading transactions...
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
{% block extra_js %}
  <script src="{% static 'js/fetchData.js' %}"></script>
  <!-- Visual Select to Styled Dropdown Converter -->
  <script src="{% static 'js/dropdown_style.js' %}"></script>
  <script>
    const urls = {
      report: '{% url "invoice:report_fetch" %}',
      report_cancled: '{% url "invoice:report_cancled_fetch" %}',
      report_return: '{% url "invoice:report_return_fetch" %}',
      download_pdf: '{% url "report:invoice_report_pdf" %}',
    }
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize AJAX for both tables - they share the same form
      // We need to initialize them separately since they have different URLs
      initTableAjax('dateFilterForm', 'report_table', urls.report, {
        method: 'GET',
        loadingText: 'Loading transactions...',
        autoLoad: true,
      }, false)

      initTableAjax('dateFilterForm', 'cancled_report_table', urls.report_cancled, {
        method: 'GET',
        loadingText: 'Loading cancelled transactions...',
        autoLoad: true,
      }, false)

      initTableAjax('dateFilterForm', 'return_report_table', urls.report_return, {
        method: 'GET',
        loadingText: 'Loading return transactions...',
        autoLoad: true,
      }, false)

      // Initialize styled dropdown for date filter
      if (typeof convertSelectToStyledDropdown !== 'undefined') {
        setTimeout(() => {
          const dateFilterSelect = document.getElementById('dateFilter')
          if (dateFilterSelect && !window.dateFilter_styled) {
            convertSelectToStyledDropdown('dateFilter', {
              onChange: function(data) {
                // Store custom dates in data attributes for later retrieval
                if (data.value === 'custom' && data.fromDate && data.toDate) {
                  const styledRef = window.dateFilter_styled
                  const hiddenSelect = styledRef?.hiddenSelect
                  if (hiddenSelect) {
                    hiddenSelect.setAttribute('data-from-date', data.fromDate)
                    hiddenSelect.setAttribute('data-to-date', data.toDate)
                  }
                }
                // Reload both tables when filter changes
                reloadTable('report_table')
                reloadTable('cancled_report_table')
                reloadTable('return_report_table')
              }
            })
          }
        }, 100)
      }

      // Download Report function using fetchData.js helper
      const downloadReportBtn = document.getElementById('downloadReportBtn')
      if (downloadReportBtn) {
        downloadReportBtn.addEventListener('click', function(e) {
          e.preventDefault()
          downloadTablePDF('dateFilterForm', 'report_table', urls.download_pdf)
        })
      }
    })
  </script>
{% endblock extra_js %}
