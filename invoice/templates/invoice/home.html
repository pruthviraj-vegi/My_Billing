{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}
  Invoices Management
{% endblock title %}
{% block content %}
  <!-- Page Header -->
  <div class="page-header">
    <h2 class="heading page-title">Invoices Management</h2>
    <div class="page-actions">
      <a href="#" id="downloadBtn" class="btn btn-primary">
        <i class="fas fa-download"></i>
        Download
      </a>
      <button type="button" class="btn btn-info" id="downloadReportBtn">
        <i class="fas fa-download"></i>
        Download Report
      </button>
      <a href="{% url 'cart:main_page' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        New Invoice
      </a>
    </div>
  </div>
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb breadcrumb-right">
    <a href="#" class="breadcrumb-item">Invoices</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-active">All Invoices</span>
  </nav>
  <!-- Search and Filter Section -->
  <div class="search-filter-section">
    <form method="#"
          class="search-filter-form"
          id="searchForm"
          autocomplete="off">
      <div class="search-group search-expanded">
        <i class="fas fa-search search-icon"></i>
        <div class="search-input-container">
          <input type="search"
                 name="search"
                 class="search-input"
                 placeholder="Search invoices by number, customer name, phone, or notes..."
                 value=""
                 id="searchInput"
                 autofocus>
        </div>
      </div>
      <select name="payment_type" class="filter-select" id="paymentTypeFilter">
        <option value="">All Types</option>
        {% for value, label in payment_type_choices %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
      </select>
      <select name="bill_types" class="filter-select" id="billTypesFilter">
        <option value="">Bill Types</option>
        {% for value, label in bill_types %}<option value="{{ value }}">{{ label }}</option>{% endfor %}
      </select>
      <select name="financial_year" class="filter-select" id="financialYearFilter">
        <option value="">All Years</option>
        {% for year in financial_years %}<option value="{{ year }}">{{ year }}</option>{% endfor %}
      </select>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-search"></i>
        Search
      </button>
    </form>
  </div>
  <!-- Data Table -->
  <div class="table-container">
    <table class="data-table" id="data_table">
      <thead>
        <tr>
          <th class="sortable" data-sort="invoice_number">Invoice #</th>
          <th class="sortable" data-sort="customer__name">Customer</th>
          <th class="sortable" data-sort="payment_type">Type</th>
          <th class="sortable" data-sort="amount">Amount</th>
          <th class="sortable" data-sort="payment_status">Status</th>
          <th class="sortable" data-sort="invoice_date">Date</th>
          <th class="sortable" data-sort="due_date">Due Date</th>
          <th class="sortable" data-sort="created_by__username">Sold By</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="table_body">
        <!-- Empty table body - data will be loaded via AJAX -->
        <tr>
          <td colspan="8" class="text-center p-3">
            <i class="fas fa-spinner fa-spin"></i>
            Loading invoices...
            <br>
            <br>
            <button type="button"
                    class="btn btn-sm btn-outline-primary"
                    onclick="window.retryTableLoad()">
              <i class="fas fa-refresh"></i>
              Retry
            </button>
          </td>
        </tr>
      </tbody>
      <tfoot id="table_footer">
        <!-- Pagination will be loaded here via AJAX -->
      </tfoot>
    </table>
  </div>
  <div class="modal-overlay" id="downloadReportModal">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Download Invoice Report</h4>
        <button type="button"
                class="btn-close"
                id="closeDownloadModal"
                aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="downloadReportForm" class="d-flex flex-column gap-2">
          <div class="form-group mb-3">
            <label for="reportDateFilter" class="form-label">Select Date Range</label>
            <select name="date_filter" class="form-select" id="reportDateFilter">
              <option value="this_month">This Month</option>
              <option value="last_month">Last Month</option>
              <option value="this_quarter">This Quarter</option>
              <option value="last_quarter">Last Quarter</option>
              <option value="this_finance">This Finance</option>
              <option value="last_finance">Last Finance</option>
              <option value="custom">Custom Date</option>
            </select>
          </div>
          <!-- Custom Date Inputs (shown when Custom is selected) -->
          <div class="form-group custom-date-inputs" id="customDateInputs">
            <label class="form-label">Select Custom Date Range</label>
            <div class="row gap-2">
              <div class="date-picker custom-date-picker">
                <div class="form-custom cal-icon">
                  <input class="form-input"
                         type="text"
                         id="customFromDate"
                         placeholder="From: dd-mm-yyyy"
                         readonly>
                </div>
              </div>
              <div class="date-picker custom-date-picker">
                <div class="form-custom cal-icon">
                  <input class="form-input"
                         type="text"
                         id="customToDate"
                         placeholder="To: dd-mm-yyyy"
                         readonly>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelDownloadBtn">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitDownloadBtn">
          <i class="fas fa-download"></i>
          Download
        </button>
      </div>
    </div>
  </div>
{% endblock content %}
{% block extra_js %}
  <script>
        urls = {
            fetch: '{% url "invoice:fetch" %}',
            suggestions: '{% url "suggestions:invoice_all" %}',
            invoices_pdf: '{% url "report:invoices_pdf" %}',
            invoice_report_pdf: '{% url "report:invoices_pdf" %}',
        }
  </script>
  <!-- Load dependencies -->
  <script src="{% static 'js/wordSuggestion.js' %}"></script>
  <script src="{% static 'js/fetchData.js' %}"></script>
  <script src="{% static 'js/dropdown_style.js' %}"></script>
  <script>
        // Simple, clean initialization - just like Select2!
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize word suggestion on search input - jQuery-like syntax!
            $('#searchInput').wordSuggestion({
                url: urls.suggestions,
                placeholder: 'Type to search invoices...',
                minLength: 2,
                onSelect: function(suggestion, input) {
                    // Auto-reload table when suggestion is selected
                    reloadTable('data_table');
                }
            });
            
            // Initialize table AJAX on search form - jQuery-like syntax!
            $('#searchForm').ajax({
                tableId: 'data_table',
                url: urls.fetch,
                placeholder: 'Loading invoices...',
                includeInputs: false
            });
        });

        const downloadBtn = document.getElementById('downloadBtn');
        if (downloadBtn) {
          downloadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            downloadTablePDF('searchForm', 'data_table', urls.invoices_pdf);
          });
        }
  </script>
  <script>
    // Download Report Modal functionality
    const downloadModal = document.getElementById('downloadReportModal')
    const downloadReportBtn = document.getElementById('downloadReportBtn')
    const closeModalBtn = document.getElementById('closeDownloadModal')
    const cancelBtn = document.getElementById('cancelDownloadBtn')
    const submitBtn = document.getElementById('submitDownloadBtn')
    const customDateInputs = document.getElementById('customDateInputs')
    const customFromDate = document.getElementById('customFromDate')
    const customToDate = document.getElementById('customToDate')
    
    if (!downloadModal || !downloadReportBtn || !closeModalBtn || !cancelBtn || !submitBtn) {
      console.warn('Download report modal elements not found')
    } else {
      let dropdownInitialized = false
      let fromDatePicker = null
      let toDatePicker = null

      // Initialize date pickers for custom inputs
      function initializeCustomDatePickers() {
        if (typeof DatePicker === 'undefined') {
          console.warn('DatePicker.js not loaded - custom date inputs will not work')
          return
        }

        if (!fromDatePicker && customFromDate) {
          try {
            fromDatePicker = new DatePicker('#customFromDate', {
              mode: 'single',
              format: 'd-m-Y',
              showIcon: true,
              iconPosition: 'right',
              clickOpens: true,
              allowInput: false,
              closeOnSelect: true,
              onChange: (date) => {
                if (date) {
                  const isoDate = date.toISOString().split('T')[0]
                  customFromDate.setAttribute('data-iso-date', isoDate)
                }
              }
            })
          } catch (error) {
            console.error('Error initializing from date picker:', error)
          }
        }

        if (!toDatePicker && customToDate) {
          try {
            toDatePicker = new DatePicker('#customToDate', {
              mode: 'single',
              format: 'd-m-Y',
              showIcon: true,
              iconPosition: 'right',
              clickOpens: true,
              allowInput: false,
              closeOnSelect: true,
              onChange: (date) => {
                if (date) {
                  const isoDate = date.toISOString().split('T')[0]
                  customToDate.setAttribute('data-iso-date', isoDate)
                }
              }
            })
          } catch (error) {
            console.error('Error initializing to date picker:', error)
          }
        }
      }

    // Open modal
    downloadReportBtn.addEventListener('click', function () {
      downloadModal.style.display = 'flex'
      // Reset custom date inputs
      customDateInputs.style.display = 'none'
      customFromDate.value = ''
      customToDate.value = ''
      customFromDate.removeAttribute('data-iso-date')
      customToDate.removeAttribute('data-iso-date')
      
      // Initialize dropdown after modal is shown (only once)
      if (!dropdownInitialized && typeof convertSelectToStyledDropdown !== 'undefined') {
        setTimeout(() => {
          // Check if already converted
          if (!window.reportDateFilter_styled) {
            const selectElement = document.getElementById('reportDateFilter')
            if (selectElement) {
              convertSelectToStyledDropdown('reportDateFilter', {
                onChange: function(data) {
                  // Show/hide custom date inputs based on selection
                  if (data.value === 'custom') {
                    customDateInputs.style.display = 'block'
                    // Hide date inputs inside dropdown (if they exist)
                    const styledRef = window.reportDateFilter_styled
                    if (styledRef && styledRef.checkBoxes) {
                      const dropdownDateInputs = styledRef.checkBoxes.querySelector('.date-list:last-of-type')
                      if (dropdownDateInputs) {
                        dropdownDateInputs.style.display = 'none'
                      }
                    }
                    // Initialize date pickers when custom is selected
                    setTimeout(() => {
                      initializeCustomDatePickers()
                    }, 50)
                  } else {
                    customDateInputs.style.display = 'none'
                    // Show date inputs in dropdown again (if they exist)
                    const styledRef = window.reportDateFilter_styled
                    if (styledRef && styledRef.checkBoxes) {
                      const dropdownDateInputs = styledRef.checkBoxes.querySelector('.date-list:last-of-type')
                      if (dropdownDateInputs) {
                        dropdownDateInputs.style.display = 'block'
                      }
                    }
                    // Clear custom dates when other option is selected
                    customFromDate.value = ''
                    customToDate.value = ''
                    customFromDate.removeAttribute('data-iso-date')
                    customToDate.removeAttribute('data-iso-date')
                  }
                }
              })
              
              // Hide date inputs in dropdown initially (we'll use modal inputs instead)
              setTimeout(() => {
                const styledRef = window.reportDateFilter_styled
                if (styledRef && styledRef.checkBoxes) {
                  const dropdownDateInputs = styledRef.checkBoxes.querySelector('.date-list:last-of-type')
                  if (dropdownDateInputs) {
                    dropdownDateInputs.style.display = 'none'
                  }
                }
              }, 150)
              dropdownInitialized = true
            }
          } else {
            dropdownInitialized = true
          }
        }, 100)
      }
    })

    // Close modal handlers
    function closeModal() {
      downloadModal.style.display = 'none'
      // Reset custom date inputs when closing
      customDateInputs.style.display = 'none'
      customFromDate.value = ''
      customToDate.value = ''
      customFromDate.removeAttribute('data-iso-date')
      customToDate.removeAttribute('data-iso-date')
    }

    closeModalBtn.addEventListener('click', closeModal)
    cancelBtn.addEventListener('click', closeModal)

    // Close on backdrop click
    downloadModal.addEventListener('click', function(e) {
      if (e.target === downloadModal) {
        closeModal()
      }
    })

    // Submit download
    submitBtn.addEventListener('click', function() {
      const styledRef = window.reportDateFilter_styled
      const hiddenSelect = styledRef?.hiddenSelect || document.getElementById('reportDateFilter') || document.getElementById('reportDateFilter_hidden')
      
      if (!hiddenSelect) {
        console.error('Date filter not found')
        return
      }

      const selectedValue = hiddenSelect.value

      // Prepare request data
      const requestData = {
        date_filter: selectedValue
      }

      // Show loading state
      const originalText = submitBtn.innerHTML
      
      // Add custom dates if available (from modal inputs, not dropdown)
      if (selectedValue === 'custom') {
        const fromDate = customFromDate.getAttribute('data-iso-date')
        const toDate = customToDate.getAttribute('data-iso-date')
        
        if (!fromDate || !toDate) {
          alert('Please select both From and To dates for custom date range.')
          submitBtn.innerHTML = originalText
          submitBtn.disabled = false
          return
        }
        
        requestData.from_date = fromDate
        requestData.to_date = toDate
      }
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...'
      submitBtn.disabled = true

      // Build URL with query parameters
      let downloadUrl = urls.invoice_report_pdf
      const separator = downloadUrl.includes('?') ? '&' : '?'
      downloadUrl += `${separator}date_filter=${encodeURIComponent(requestData.date_filter)}`
      
      if (requestData.from_date) {
        downloadUrl += `&from_date=${encodeURIComponent(requestData.from_date)}`
      }
      if (requestData.to_date) {
        downloadUrl += `&to_date=${encodeURIComponent(requestData.to_date)}`
      }

      // Open PDF in new tab
      try {
        window.open(downloadUrl, '_blank')
        // Close modal after a short delay
        setTimeout(() => {
          closeModal()
          // Reset button state
          submitBtn.innerHTML = originalText
          submitBtn.disabled = false
        }, 500)
      } catch (error) {
        console.error('Error opening PDF:', error)
        alert('Failed to open report. Please try again.')
        // Reset button state
        submitBtn.innerHTML = originalText
        submitBtn.disabled = false
      }
    })
    }
  </script>
{% endblock extra_js %}
