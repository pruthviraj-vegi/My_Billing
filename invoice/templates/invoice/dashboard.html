{% extends "base.html" %}

{% load static %}
{% load custom_filters %}

{% block title %}Invoice Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard-charts.css' %}">
{% endblock extra_css %}

{% block content %}

<!-- Page Header -->
<div class="page-header page-header-sticky">
    <h2 class="page-title">Invoice Dashboard</h2>
    <div class="page-actions">
        <!-- Date Filter Dropdown -->
        <form method="get" class="d-inline" id="dateFilterForm">
            <select name="date_filter" class="form-select" id="dateFilter">
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="this_month">This Month</option>
                <option value="last_month">Last Month</option>
                <option value="this_finance">This Finance</option>
                <option value="last_finance">Last Finance</option>
                <option value="this_quarter">This Quarter</option>
                <option value="last_quarter">Last Quarter</option>
                <option value="full_date">Full Date</option>
            </select>
        </form>
        <a href="{% url 'invoice:home' %}" class="btn">
            <i class="fas fa-list"></i>
            View All Invoices
        </a>
    </div>
</div>

<!-- Breadcrumb Navigation -->
<nav class="breadcrumb breadcrumb-right">
    <a href="{% url 'base:home' %}" class="breadcrumb-item">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-active">Invoice Dashboard</span>
</nav>

<!-- Loading State - Hidden for seamless updates -->
<div id="dashboardLoading" class="loading-container" style="display: none;">
    <div class="loading">
        <i class="fas fa-spinner fa-spin"></i>
        Loading dashboard data...
    </div>
</div>

<!-- Dashboard Content -->
<div id="dashboardContent" class="dashboardContent">
    <!-- Quick Stats -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-file-invoice"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number counting-number" id="totalInvoices" data-count="0">0</h3>
                <p class="stat-label">Total Invoices</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-rupee-sign"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number counting-number" id="totalAmount" data-count="0">0</h3>
                <p class="stat-label">Total Amount</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calculator"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number counting-number" id="netAmount" data-count="0">0</h3>
                <p class="stat-label">Net Amount</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number counting-number" id="totalProfit" data-count="0">0</h3>
                <p class="stat-label">Amount</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-percentage"></i>
            </div>
            <div class="stat-content">
                <h3 class="stat-number counting-number" id="totalDiscount" data-count="0">0</h3>
                <p class="stat-label">Total Discount</p>
            </div>
        </div>
    </div>

    <!-- Payment Analytics -->
    <div class="activity-section">
        <h2 class="section-title">Payment Analytics</h2>
        
        <!-- Payment Status Breakdown -->
        <div class="breakdown-grid">
            <!-- Payment Status -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Payment Status</h3>
                </div>
                <div class="payment-chart-wrapper">
                    <div class="payment-chart-container">
                        <canvas id="paymentStatusChart"></canvas>
                    </div>
                    <div id="paymentLegend" class="custom-legend"></div>
                </div>
            </div>

            <!-- Payment Type -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Payment Type</h3>
                </div>
                <div class="payment-chart-wrapper">
                    <div class="payment-chart-container">
                        <canvas id="paymentTypeChart"></canvas>
                    </div>
                    <div id="paymentTypeLegend" class="custom-legend"></div>
                </div>
            </div>

            <!-- Product Categories -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3 class="chart-title">Top Categories</h3>
                </div>
                <div class="payment-chart-wrapper">
                    <div class="payment-chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div id="categoryLegend" class="custom-legend"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- Revenue Comparison Chart -->
    <div class="activity-section">
        <h2 class="section-title">Revenue Comparison</h2>
        <div class="chart-card revenue-chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Revenue Analytics</h3>
                <div class="chart-summary-stats">
                    <div class="stat-item">
                        <span class="stat-label-small"><span class="legend-dot" style="background: var(--primary);"></span>Present</span>
                        <span class="stat-value-small" id="revCurrentTotal">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label-small"><span class="legend-dot" style="background: var(--secondary);"></span>Past</span>
                        <span class="stat-value-small" id="revPreviousTotal">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label-small">Change</span>
                        <span class="stat-change" id="revChange">--</span>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>

    </div>


    <!-- Quick Actions -->
    <div class="quick-actions">
        <h2 class="section-title">Quick Actions</h2>
        <div class="actions-grid">
            <a href="{% url 'invoice:home' %}" class="action-card">
                <i class="fas fa-list"></i>
                <span>View All Invoices</span>
            </a>
            <a href="#" class="action-card">
                <i class="fas fa-plus"></i>
                <span>Create Invoice</span>
            </a>
            <a href="#" class="action-card">
                <i class="fas fa-chart-bar"></i>
                <span>Generate Report</span>
            </a>
            <a href="#" class="action-card">
                <i class="fas fa-download"></i>
                <span>Export Data</span>
            </a>
        </div>
    </div>
</div>

<!-- Error State -->
<div id="dashboardError" class="error-container" style="display: none;">
    <div class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Failed to load dashboard data</h3>
        <p>Please try again or contact support if the problem persists.</p>
        <button type="button" class="btn btn-primary" id="retryDashboardBtn">
            <i class="fas fa-refresh"></i>
            Retry
        </button>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
{% load static %}
<script src="{% static 'assets/plugins/chart/chart-4.5.js' %}"></script>
<script src="{% static 'js/modern-charts.js' %}"></script>
<script src="{% static 'js/counting.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Charts
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const paymentCtx = document.getElementById('paymentStatusChart').getContext('2d');
    const paymentTypeCtx = document.getElementById('paymentTypeChart').getContext('2d');
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    
    let revenueChart = ModernCharts.initRevenueChart(revenueCtx);
    let paymentChart = ModernCharts.initDoughnut(paymentCtx);
    let paymentTypeChart = ModernCharts.initDoughnut(paymentTypeCtx);
    let categoryChart = ModernCharts.initDoughnut(categoryCtx);

    // Fetch Data Function
    async function fetchDashboardData(filter) {
        try {
            // Don't block the UI
            // document.getElementById('dashboardLoading').style.display = 'flex';
            // document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('dashboardError').style.display = 'none';
            
            // Subtle loading indication
            document.getElementById('dashboardContent').style.opacity = '0.6';

            const response = await fetch(`{% url "invoice:dashboard_fetch" %}?date_filter=${filter}`);
            const data = await response.json();
            
            if (data.success) {
                updateDashboard(data);
                document.getElementById('dashboardContent').style.opacity = '1';
            } else {
                throw new Error(data.message || 'Failed to fetch data');
            }
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
            document.getElementById('dashboardContent').style.opacity = '1';
            document.getElementById('dashboardError').style.display = 'flex';
        } finally {
            // document.getElementById('dashboardLoading').style.display = 'none';
        }
    }

    function updateDashboard(data) {
        // Update Stats with counting animation
        updateCount('totalInvoices', data.stats.total_invoices);
        updateCount('totalAmount', data.stats.total_amount);
        updateCount('netAmount', data.stats.net_amount);
        updateCount('totalProfit', data.stats.total_profit);
        updateCount('totalDiscount', data.stats.total_discount);

        // Update Revenue Chart
        if (data.comparison_data) {
            const { currentData, previousData } = ModernCharts.updateRevenueChart(revenueChart, data.comparison_data);
            
            // Update Summary Totals
            ModernCharts.updateSummaryStats(currentData, previousData, {
                current: 'revCurrentTotal',
                previous: 'revPreviousTotal',
                change: 'revChange'
            });
        }

        // Update Payment Status Chart - Using backend-calculated percentages
        ModernCharts.updateDoughnut(
            paymentChart, 
            'paymentLegend', 
            data.payment_status_breakdown, 
            { label: 'payment_status', count: 'count', amount: 'amount', percentage: 'percentage' }
        );

        // Update Payment Type Chart - Using backend-calculated percentages
        ModernCharts.updateDoughnut(
            paymentTypeChart, 
            'paymentTypeLegend', 
            data.payment_type_breakdown, 
            { label: 'payment_type', count: 'count', amount: 'amount', percentage: 'percentage' }
        );

        // Update Category Chart - Using backend-calculated percentages
        ModernCharts.updateDoughnut(
            categoryChart, 
            'categoryLegend', 
            data.category_breakdown, 
            { label: 'category_name', count: 'count', amount: 'amount', percentage: 'percentage' }
        );
    }

    // Event Listeners
    const dateFilter = document.getElementById('dateFilter');
    if (dateFilter) {
        dateFilter.addEventListener('change', (e) => {
            fetchDashboardData(e.target.value);
        });
    }

    const retryBtn = document.getElementById('retryDashboardBtn');
    if (retryBtn) {
        retryBtn.addEventListener('click', () => {
            document.getElementById('dashboardError').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
            fetchDashboardData(dateFilter ? dateFilter.value : 'today');
        });
    }

    // Initial Load
    fetchDashboardData('today');
});
</script>
{% endblock extra_js %}