{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ title }}{% endblock title %}

{% block content %}
    {% csrf_token %}
    <!-- Page Header -->
    <div class="page-header">
        <h2 class="page-title">{{ title }}</h2>
        <div class="page-actions">
            <a href="{% url 'invoice:return_home' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Returns
            </a>
            <button type="button" class="btn btn-primary" id="saveChangesBtn">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
        </div>
    </div>

    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb breadcrumb-right">
        <a href="{% url 'invoice:return_home' %}" class="breadcrumb-item">Return Invoices</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-active">Stock Adjustment</span>
    </nav>

    <!-- Return Invoice Summary -->
    <div class="form-section mb-3">
        <h5 class="section-title">Return Invoice Summary</h5>
        <div class="row">
            <div class="col-md-3">
                <div class="info-card">
                    <div class="info-label">Return Number</div>
                    <div class="info-value">{{ return_invoice.return_number }}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-card">
                    <div class="info-label">Customer</div>
                    <div class="info-value">{{ return_invoice.customer.name }}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-card">
                    <div class="info-label">Original Invoice</div>
                    <div class="info-value">{{ return_invoice.invoice.invoice_number }}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="info-card">
                    <div class="info-label">Status</div>
                    <div class="info-value">
                        {% if return_invoice.status == 'PENDING' %}
                            <span class="status-badge status-pending">{{ return_invoice.get_status_display }}</span>
                        {% elif return_invoice.status == 'APPROVED' %}
                            <span class="status-badge status-approved">{{ return_invoice.get_status_display }}</span>
                        {% else %}
                            <span class="status-badge status-default">{{ return_invoice.get_status_display }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Items Management Section -->
    <div class="form-section">
        <h5 class="section-title">Return Items Management</h5>
        
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="summary-card">
                    <div class="summary-label">Total Items</div>
                    <div class="summary-value" id="totalItems">{{ return_items|length }}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <div class="summary-label">Items to Return</div>
                    <div class="summary-value" id="itemsToReturn">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <div class="summary-label">Original Invoice Amount</div>
                    <div class="summary-value" id="totalAmount">{{return_invoice.invoice.amount|currency}}</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <div class="summary-label">Refund Amount</div>
                    <div class="summary-value" id="refundAmount">{{return_invoice.refund_amount|currency}}</div>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Original Qty</th>
                        <th>Return Qty</th>
                        <th>Unit Price</th>
                        <th>Total Amount</th>
                        <th>Condition</th>
                        <th>Return Reason</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in return_items %}
                        <tr data-item-id="{{ item.id }}">
                            <td>
                                <div class="product-info">
                                    <div class="product-name">{{ item.product_variant.product.name }}</div>
                                    {% if item.product_variant.name %}
                                        <div class="product-variant">{{ item.product_variant.name }}</div>
                                    {% endif %}
                                    {% if item.product_variant.barcode %}
                                        <div class="product-barcode">{{ item.product_variant.barcode }}</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div class="quantity-display">{{ item.quantity_original }}</div>
                            </td>
                            <td>
                                <div class="quantity-input-group">
                                    <input type="number" 
                                           class="form-input quantity-input" 
                                           value="{{ item.quantity_returned }}"
                                           min="0" 
                                           max="{{ item.quantity_original }}"
                                           step="0.01"
                                           data-item-id="{{ item.id }}"
                                           data-original-qty="{{ item.quantity_original }}">
                                </div>
                            </td>
                            <td>
                                <div class="price-display">{{ item.unit_price|currency }}</div>
                            </td>
                            <td>
                                <div class="amount-display" id="amount-{{ item.id }}">{{ item.total_amount|currency }}</div>
                            </td>
                            <td>
                                <select class="form-select condition-select" 
                                        data-item-id="{{ item.id }}">
                                    {% for value, label in item_condition_choices %}
                                        <option value="{{ value }}" 
                                                {% if item.condition == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <select class="form-select reason-select" 
                                        data-item-id="{{ item.id }}">
                                    {% for value, label in item_return_reason_choices %}
                                        <option value="{{ value }}" 
                                                {% if item.return_reason == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" 
                                            class="btn-action btn-update" 
                                            data-item-id="{{ item.id }}"
                                            title="Update Item">
                                        <i class="fas fa-sync"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" class="text-center" style="padding: 3rem;">
                                <div class="empty-state">
                                    <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 1rem; color: var(--text-secondary);"></i>
                                    <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">No Items Found</h4>
                                    <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">This return invoice has no items to manage.</p>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Action Buttons -->
        <div class="form-actions mt-4">
            <button type="button" class="btn btn-primary" id="updateAllBtn">
                <i class="fas fa-save"></i>
                Update All Items
            </button>
            <button type="button" class="btn btn-secondary" id="resetAllBtn">
                <i class="fas fa-undo"></i>
                Reset All
            </button>
            <button type="button" class="btn btn-success" id="submitReturnBtn">
                <i class="fas fa-check-circle"></i>
                Submit Return
            </button>
            <a href="{% url 'invoice:return_home' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i>
                Cancel
            </a>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Stock adjustment page loaded');
    
    const updateItemBtn = document.querySelectorAll('.btn-update');
    const quantityInputs = document.querySelectorAll('.quantity-input');
    const conditionSelects = document.querySelectorAll('.condition-select');
    const reasonSelects = document.querySelectorAll('.reason-select');
    const updateAllBtn = document.getElementById('updateAllBtn');
    const resetAllBtn = document.getElementById('resetAllBtn');
    const saveChangesBtn = document.getElementById('saveChangesBtn');
    const submitReturnBtn = document.getElementById('submitReturnBtn');
    
    // Track original values to detect changes
    const originalValues = new Map();
    
    
    
    // Store original values for each item
    function storeOriginalValues() {
        document.querySelectorAll('tr[data-item-id]').forEach(row => {
            const itemId = row.getAttribute('data-item-id');
            const quantityInput = row.querySelector('.quantity-input');
            const conditionSelect = row.querySelector('.condition-select');
            const reasonSelect = row.querySelector('.reason-select');
            
            if (itemId && quantityInput && conditionSelect && reasonSelect) {
                originalValues.set(itemId, {
                    quantity: quantityInput.value,
                    condition: conditionSelect.value,
                    reason: reasonSelect.value
                });
            }
        });
    }
    
    // Check if item has changes
    function hasItemChanged(itemId) {
        const original = originalValues.get(itemId);
        if (!original) return false;
        
        const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
        if (!row) return false;
        
        const quantityInput = row.querySelector('.quantity-input');
        const conditionSelect = row.querySelector('.condition-select');
        const reasonSelect = row.querySelector('.reason-select');
        
        if (!quantityInput || !conditionSelect || !reasonSelect) return false;
        
        return (
            quantityInput.value !== original.quantity ||
            conditionSelect.value !== original.condition ||
            reasonSelect.value !== original.reason
        );
    }
    
    // Get all changed items
    function getChangedItems() {
        const changedItems = [];
        document.querySelectorAll('tr[data-item-id]').forEach(row => {
            const itemId = row.getAttribute('data-item-id');
            if (itemId && hasItemChanged(itemId)) {
                changedItems.push(itemId);
            }
        });
        return changedItems;
    }

    // Update individual item
    function updateItem(itemId) {
        // Check if item has changes before updating
        if (!hasItemChanged(itemId)) {
            console.log(`No changes detected for item ${itemId}, skipping update`);
            showMessage('No changes detected for this item', 'info');
            return;
        }
        
        const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
        if (!row) {
            console.error(`Row not found for item ID: ${itemId}`);
            return;
        }
        
        const quantityInput = row.querySelector('.quantity-input');
        const conditionSelect = row.querySelector('.condition-select');
        const reasonSelect = row.querySelector('.reason-select');
        
        if (!quantityInput || !conditionSelect || !reasonSelect) {
            console.error(`Required elements not found for item ID: ${itemId}`);
            return;
        }
        
        const formData = new FormData();
        formData.append('quantity_returned', quantityInput.value);
        formData.append('condition', conditionSelect.value);
        formData.append('return_reason', reasonSelect.value);
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken.value);
        }

        fetch(`/invoice/returns/update-item/${itemId}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update amount display
                document.getElementById(`amount-${itemId}`).textContent = `${parseFloat(data.item_total).toFixed(2)}`;
                
                // Update refund amount (total amount stays as original invoice amount)
                document.getElementById('refundAmount').textContent = `${parseFloat(data.refund_amount).toFixed(2)}`;
                
                // Update items to return count
                updateItemsToReturnCount();
                
                // Update original values to reflect current state
                originalValues.set(itemId, {
                    quantity: quantityInput.value,
                    condition: conditionSelect.value,
                    reason: reasonSelect.value
                });
                
                // Show success message
                showMessage('Item updated successfully!', 'success');
            } else {
                showMessage(data.error || 'Error updating item', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('Error updating item', 'error');
        });
    }

    // Update all items
    async function updateAllItems() {
        const changedItems = getChangedItems();
        
        if (changedItems.length === 0) {
            showMessage('No changes detected in any items', 'info');
            return;
        }
        
        console.log(`Updating ${changedItems.length} changed items:`, changedItems);
        
        const promises = changedItems.map(itemId => updateItemAsync(itemId));
        
        try {
            await Promise.all(promises);
            showMessage(`${changedItems.length} items updated successfully!`, 'success');
        } catch (error) {
            console.error('Error updating items:', error);
            showMessage('Some items failed to update', 'error');
        }
    }
    
    // Async version of updateItem for Promise.all
    async function updateItemAsync(itemId) {
        return new Promise((resolve, reject) => {
            // Check if item has changes before updating
            if (!hasItemChanged(itemId)) {
                console.log(`No changes detected for item ${itemId}, skipping update`);
                resolve({ success: true, skipped: true });
                return;
            }
            
            const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
            if (!row) {
                reject(new Error(`Row not found for item ID: ${itemId}`));
                return;
            }
            
            const quantityInput = row.querySelector('.quantity-input');
            const conditionSelect = row.querySelector('.condition-select');
            const reasonSelect = row.querySelector('.reason-select');
            
            if (!quantityInput || !conditionSelect || !reasonSelect) {
                reject(new Error(`Required elements not found for item ID: ${itemId}`));
                return;
            }
            
            const formData = new FormData();
            formData.append('quantity_returned', quantityInput.value);
            formData.append('condition', conditionSelect.value);
            formData.append('return_reason', reasonSelect.value);
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                formData.append('csrfmiddlewaretoken', csrfToken.value);
            }

            fetch(`/invoice/returns/update-item/${itemId}/`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update amount display
                    const amountElement = document.getElementById(`amount-${itemId}`);
                    if (amountElement) {
                        amountElement.textContent = `â‚¹${parseFloat(data.item_total).toFixed(2)}`;
                    }
                    
                    // Update refund amount (total amount stays as original invoice amount)
                    const refundAmountElement = document.getElementById('refundAmount');
                    
                    if (refundAmountElement) {
                        refundAmountElement.textContent = `${parseFloat(data.refund_amount).toFixed(2)}`;
                    }
                    
                    // Update original values to reflect current state
                    originalValues.set(itemId, {
                        quantity: quantityInput.value,
                        condition: conditionSelect.value,
                        reason: reasonSelect.value
                    });
                    
                    resolve(data);
                } else {
                    showMessage(data.error || 'Error updating item', 'error');
                    reject(new Error(data.error || 'Error updating item'));
                }
            })
            .catch(error => {
                console.error('Error updating item:', error);
                showMessage('Error updating item', 'error');
                reject(error);
            });
        });
    }

    // Reset all items
    function resetAllItems() {
        if (confirm('Are you sure you want to reset all items to 0 quantity?')) {
            quantityInputs.forEach(input => {
                input.value = '0';
            });
            updateItemsToReturnCount();
            showMessage('All items reset to 0', 'info');
        }
    }

    // Submit return invoice
    async function submitReturn() {
        // Check if there are any changes that need to be saved first
        const changedItems = getChangedItems();
        
        if (changedItems.length > 0) {
            showMessage(`Saving ${changedItems.length} pending changes before submission...`, 'info');
            
            // Save all changes first
            try {
                await updateAllItems();
                showMessage('Changes saved successfully. Proceeding with submission...', 'success');
            } catch (error) {
                showMessage('Failed to save changes. Please try again.', 'error');
                return;
            }
        }
        
        // Check if there are any items to return
        const itemsToReturn = document.querySelectorAll('.quantity-input');
        let hasItemsToReturn = false;
        
        itemsToReturn.forEach(input => {
            if (parseFloat(input.value) > 0) {
                hasItemsToReturn = true;
            }
        });
        
        if (!hasItemsToReturn) {
            showMessage('Please select at least one item to return before submitting.', 'error');
            return;
        }
        
        // Confirm submission
        if (!confirm('Are you sure you want to submit this return? This action cannot be undone.')) {
            return;
        }
        
        // Disable submit button and show loading
        submitReturnBtn.disabled = true;
        submitReturnBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        
        try {
            // Use the return invoice ID from template context
            const returnId = {{ return_invoice.id }};
            
            console.log('Return ID:', returnId);
            
            const response = await fetch(`/invoice/returns/submit/${returnId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage('Return submitted successfully!', 'success');
                // Redirect to return home after a short delay
                setTimeout(() => {
                    window.location.href = '{% url "invoice:return_home" %}';
                }, 2000);
            } else {
                showMessage(data.error || 'Failed to submit return', 'error');
            }
        } catch (error) {
            console.error('Error submitting return:', error);
            showMessage('Error submitting return. Please try again.', 'error');
        } finally {
            // Re-enable submit button
            submitReturnBtn.disabled = false;
            submitReturnBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Return';
        }
    }

    // Update items to return count
    function updateItemsToReturnCount() {
        let count = 0;
        quantityInputs.forEach(input => {
            if (parseFloat(input.value) > 0) {
                count++;
            }
        });
        document.getElementById('itemsToReturn').textContent = count;
    }

    // Show message
    function showMessage(message, type) {
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    // Event listeners
    updateItemBtn.forEach(btn => {
        btn.addEventListener('click', function() {
            const itemId = this.getAttribute('data-item-id');
            if (itemId) {
                updateItem(itemId);
            }
        });
    });

    quantityInputs.forEach(input => {
        input.addEventListener('input', function() {
            updateItemsToReturnCount();
        });
    });

    if (updateAllBtn) {
        updateAllBtn.addEventListener('click', updateAllItems);
    }
    if (resetAllBtn) {
        resetAllBtn.addEventListener('click', resetAllItems);
    }
    if (saveChangesBtn) {
        saveChangesBtn.addEventListener('click', updateAllItems);
    }
    if (submitReturnBtn) {
        submitReturnBtn.addEventListener('click', submitReturn);
    }

    // Initialize original values and count
    storeOriginalValues();
    updateItemsToReturnCount();
});
</script>

<style>
.info-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
}

.info-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.info-value {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
}

.summary-card {
    background: var(--bg-surface);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1rem;
}

.summary-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.summary-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
}

.product-info {
    max-width: 200px;
}

.product-name {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.product-variant {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.product-barcode {
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-family: monospace;
}

.quantity-input-group {
    max-width: 100px;
}

.quantity-input {
    text-align: center;
    padding: 0.5rem;
}

.price-display, .amount-display {
    font-weight: 600;
    color: var(--text-primary);
}

.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
}

.toast-success {
    background: var(--success);
}

.toast-error {
    background: var(--danger);
}

.toast-info {
    background: var(--info);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>
{% endblock extra_js %}
