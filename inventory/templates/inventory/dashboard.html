{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}Inventory Dashboard{% endblock %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/dashboard-charts.css' %}">
{% endblock extra_css %}
{% block content %}
    <!-- Page Header -->
    <div class="page-header page-header-sticky">
        <h2 class="page-title">Inventory Dashboard</h2>
        <div class="page-actions">
            <!-- Date Filter Dropdown -->
            <form method="get" class="d-inline" id="dateFilterForm">
                <select name="date_filter" class="form-select" id="dateFilter">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="this_month">This Month</option>
                    <option value="last_month">Last Month</option>
                    <option value="this_finance">This Finance</option>
                    <option value="last_finance">Last Finance</option>
                    <option value="this_quarter">This Quarter</option>
                    <option value="last_quarter">Last Quarter</option>
                    <option value="full_date">Full Date</option>
                </select>
            </form>
            <a href="{% url 'inventory:product_create' %}" class="btn">
                <i class="fas fa-plus"></i>
                Add Full Product
            </a>
        </div>
    </div>
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb breadcrumb-right">
        <a href="{% url 'base:home' %}" class="breadcrumb-item">Dashboard</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-active">Inventory Dashboard</span>
    </nav>
    <!-- Loading State - Hidden for seamless updates -->
    <div id="dashboardLoading" class="loading-container" style="display: none">
        <div class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            Loading dashboard data...
        </div>
    </div>
    <!-- Dashboard Content -->
    <div id="dashboardContent" class="dashboardContent">
        <!-- Quick Stats -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-rupee-sign"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number counting-number"
                        id="totalInventoryValue"
                        data-count="0">0</h3>
                    <p class="stat-label">Total Stock Valuation</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-cubes"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number counting-number" id="totalVariants" data-count="0">0</h3>
                    <p class="stat-label">Total Variants</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number counting-number" id="totalProducts" data-count="0">0</h3>
                    <p class="stat-label">Number of Products</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number counting-number" id="stockIn" data-count="0">0</h3>
                    <p class="stat-label">Stock In</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div class="stat-content">
                    <h3 class="stat-number counting-number" id="stockOut" data-count="0">0</h3>
                    <p class="stat-label">Stock Out</p>
                </div>
            </div>
        </div>
        <!-- Supplier Analytics -->
        <div class="activity-section">
            <h2 class="section-title">Supplier Analytics</h2>
            <!-- Supplier Breakdown -->
            <div class="breakdown-grid">
                <!-- Total Stock Share -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Total Stock Share</h3>
                    </div>
                    <div class="payment-chart-wrapper">
                        <div class="payment-chart-container">
                            <canvas id="supplierTotalChart"></canvas>
                        </div>
                        <div id="supplierTotalLegend" class="custom-legend"></div>
                    </div>
                </div>
                <!-- Stock In Share -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Stock In Share</h3>
                    </div>
                    <div class="payment-chart-wrapper">
                        <div class="payment-chart-container">
                            <canvas id="supplierInChart"></canvas>
                        </div>
                        <div id="supplierInLegend" class="custom-legend"></div>
                    </div>
                </div>
                <!-- Stock Out Share -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Stock Out Share</h3>
                    </div>
                    <div class="payment-chart-wrapper">
                        <div class="payment-chart-container">
                            <canvas id="supplierOutChart"></canvas>
                        </div>
                        <div id="supplierOutLegend" class="custom-legend"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2 class="section-title">Quick Actions</h2>
            <div class="actions-grid">
                <a href="{% url 'inventory_products:home' %}" class="action-card">
                    <i class="fas fa-list"></i>
                    <span>View All Products</span>
                </a>
                <a href="{% url 'inventory:product_create' %}" class="action-card">
                    <i class="fas fa-plus"></i>
                    <span>Add Product</span>
                </a>
                <a href="{% url 'inventory:low_stock' %}" class="action-card">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Low Stock Alert</span>
                </a>
                <a href="{% url 'inventory:dashboard' %}" class="action-card">
                    <i class="fas fa-chart-bar"></i>
                    <span>Generate Report</span>
                </a>
            </div>
        </div>
    </div>
    <!-- Error State -->
    <div id="dashboardError" class="error-container hidden">
        <div class="error-message">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Failed to load dashboard data</h3>
            <p>Please try again or contact support if the problem persists.</p>
            <button type="button" class="btn btn-primary" id="retryDashboardBtn">
                <i class="fas fa-refresh"></i>
                Retry
            </button>
        </div>
    </div>
{% endblock content %}
{% block extra_js %}
    {% load static %}
    <script src="{% static 'assets/plugins/chart/chart-4.5.js' %}"></script>
    <script src="{% static 'js/modern-charts.js' %}"></script>
    <script src="{% static 'js/dropdown_style.js' %}"></script>
    <script src="{% static 'js/counting.js' %}"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
    // Initialize Charts
    const supplierTotalCtx = document.getElementById('supplierTotalChart').getContext('2d');
    const supplierInCtx = document.getElementById('supplierInChart').getContext('2d');
    const supplierOutCtx = document.getElementById('supplierOutChart').getContext('2d');
    
    let supplierTotalChart = ModernCharts.initDoughnut(supplierTotalCtx);
    let supplierInChart = ModernCharts.initDoughnut(supplierInCtx);
    let supplierOutChart = ModernCharts.initDoughnut(supplierOutCtx);

    // Total stock data from initial page load (cached, date-independent)
    const initialTotalStockData = {{ total_stock_data_json|safe }};

    updateCount('totalInventoryValue', "{{total_inventory_value}}");
    updateCount('totalVariants', "{{total_variants}}");
    updateCount('totalProducts', "{{total_products}}");

    // Fetch Data Function
    async function fetchDashboardData(filter) {
        try {
            // Don't block the UI
            // document.getElementById('dashboardLoading').style.display = 'flex';
            // document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('dashboardError').style.display = 'none';
            
            // Subtle loading indication
            document.getElementById('dashboardContent').style.opacity = '0.6';

            const response = await fetch(`{% url "inventory:dashboard_fetch" %}?date_filter=${filter}`);
            const data = await response.json();
            
            if (data.success) {
                updateDashboard(data);
                document.getElementById('dashboardContent').style.opacity = '1';
            } else {
                throw new Error(data.message || 'Failed to fetch data');
            }
        } catch (error) {
            console.error('Error fetching dashboard data:', error);
            document.getElementById('dashboardContent').style.opacity = '1';
            document.getElementById('dashboardError').style.display = 'flex';
        } finally {
            // document.getElementById('dashboardLoading').style.display = 'none';
        }
    }

    function updateDashboard(data) {
        // Update Stats
        updateCount('stockIn', data.stats.stock_in || 0);
        updateCount('stockOut', data.stats.stock_out || 0);

        // Update Supplier In Chart - Using backend-calculated percentages
        ModernCharts.updateDoughnut(
            supplierInChart, 
            'supplierInLegend', 
            data.stock_in_breakdown, 
            { label: 'supplier_name', count: 'count', amount: 'amount', percentage: 'percentage' }
        );

        // Update Supplier Out Chart - Using backend-calculated percentages
        ModernCharts.updateDoughnut(
            supplierOutChart, 
            'supplierOutLegend', 
            data.stock_out_breakdown, 
            { label: 'supplier_name', count: 'count', amount: 'amount', percentage: 'percentage' }
        );
    }

    // Event Listeners
    const dateFilter = document.getElementById('dateFilter');
    if (dateFilter) {
        dateFilter.addEventListener('change', (e) => {
            fetchDashboardData(e.target.value);
        });
    }

    const retryBtn = document.getElementById('retryDashboardBtn');
    if (retryBtn) {
        retryBtn.addEventListener('click', () => {
            document.getElementById('dashboardError').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
            fetchDashboardData(dateFilter ? dateFilter.value : 'today');
        });
    }

    // Initialize total stock chart with cached data
    if (initialTotalStockData && initialTotalStockData.labels && initialTotalStockData.values) {
        const totalStockData = initialTotalStockData.labels.map((label, idx) => ({
            label: label,
            value: initialTotalStockData.values[idx],
            amount: initialTotalStockData.values[idx],
            count: 1,
            percentage: initialTotalStockData.percentages ? initialTotalStockData.percentages[idx] : 0
        }));
        
        ModernCharts.updateDoughnut(
            supplierTotalChart, 
            'supplierTotalLegend', 
            totalStockData, 
            { label: 'label', count: 'count', amount: 'amount', percentage: 'percentage' }
        );
    }

    // Initial Load
    fetchDashboardData('today');
});
    </script>
{% endblock extra_js %}
