{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}
    My Favorite Products
{% endblock title %}
{% block content %}
    <!-- Hidden CSRF token to ensure cookie is set -->
    {% csrf_token %}
    <!-- Page Header -->
    <div class="page-header">
        <h2 class="heading page-title">
            <i class="fas fa-star"></i> My Favorite Products
        </h2>
        <div class="page-actions">
            <button type="button" class="btn btn-primary" id="addFavoritesBtn">
                <i class="fas fa-plus"></i>
                Add Favorites
            </button>
            <a href="{% url 'inventory_variant:home' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Variants
            </a>
        </div>
    </div>
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb breadcrumb-right">
        <a href="{% url 'inventory_products:home' %}" class="breadcrumb-item">Products</a>
        <span class="breadcrumb-separator">/</span>
        <a href="{% url 'inventory_variant:home' %}" class="breadcrumb-item">Variants</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-active">Favorites</span>
    </nav>
    <!-- Search and Filter Section -->
    <div class="search-filter-section">
        <form method="get" class="search-filter-form" id="searchForm">
            <div class="search-group search-expanded">
                <i class="fas fa-search search-icon"></i>
                <div class="search-input-container">
                    <input type="search"
                           name="search"
                           class="search-input"
                           placeholder="Search favorites by name, brand, barcode..."
                           value=""
                           id="searchInput"
                           autocomplete="off"
                           autofocus>
                </div>
            </div>
            <button type="button" class="btn btn-primary" id="toggleFiltersBtn">
                <i class="fas fa-filter"></i>
                Filters
            </button>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i>
                Search
            </button>
            
            
        </form>
    </div>
    <!-- Data Table -->
    <div class="table-container">
        <table class="data-table" id="data_table" data-fetch-url="{% url 'inventory:fetch_favorites' %}">
            <thead>
                <tr>
                    <th class="sortable" data-sort="id">ID</th>
                    <th class="sortable" data-sort="barcode">Barcode</th>
                    <th class="sortable" data-sort="product__brand">Brand</th>
                    <th class="sortable" data-sort="product__name">Product Name</th>
                    <th>Variant</th>
                    <th class="sortable" data-sort="quantity">Quantity</th>
                    <th class="sortable" data-sort="mrp">MRP</th>
                    <th>Discount</th>
                    <th>Final Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="table_body">
                <!-- Data will be loaded here via AJAX -->
            </tbody>
        
        </table>
    </div>
    
    <!-- Add Favorites Modal -->
    <div class="modal fade" id="addFavoritesModal" tabindex="-1" aria-labelledby="addFavoritesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered" style="max-width: 95vw; width: 95vw; height: 90vh; margin: auto;">
            <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">
                <div class="modal-header" style="flex-shrink: 0; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color, #e5e7eb); background: var(--bg-surface-hover, #f9fafb);">
                    <h5 class="modal-title" id="addFavoritesModalLabel" style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary, #111827); margin: 0;">
                        <i class="fas fa-star text-warning"></i> Add Products to Favorites
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="flex: 1; overflow: hidden; padding: 1.5rem; display: flex; flex-direction: column;">
                    <!-- Search Section -->
                    <div class="search-filter-section mb-3" style="flex-shrink: 0;">
                        <form id="addFavoritesSearchForm">
                            <div class="d-flex gap-2 align-items-center">
                                <div class="search-group search-expanded flex-grow-1">
                                    <i class="fas fa-search search-icon"></i>
                                    <div class="search-input-container">
                                        <input type="search"
                                               name="search"
                                               class="search-input"
                                               placeholder="Search products by name, brand, barcode..."
                                               value=""
                                               id="addFavoritesSearchInput"
                                               autocomplete="off"
                                               style="font-size: 1rem; padding: 0.75rem;">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" style="min-width: 120px;">
                                    <i class="fas fa-search"></i>
                                    Search
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Variants List -->
                    <div class="table-container" style="flex: 1; overflow-y: auto; border: 1px solid var(--border-color, #e5e7eb); border-radius: 0.5rem; min-height: 0;">
                        <table class="data-table table-hover" style="margin: 0;">
                            <thead style="position: sticky; top: 0; z-index: 10; background: var(--bg-surface-hover, #f9fafb);">
                                <tr>
                                    <th style="padding: 0.875rem; font-weight: 600;">Barcode</th>
                                    <th style="padding: 0.875rem; font-weight: 600;">Product</th>
                                    <th style="padding: 0.875rem; font-weight: 600;">Variant</th>
                                    <th style="padding: 0.875rem; font-weight: 600;">Price</th>
                                    <th style="padding: 0.875rem; font-weight: 600;">Stock</th>
                                    <th style="padding: 0.875rem; font-weight: 600;">Action</th>
                                </tr>
                            </thead>
                            <tbody id="addFavoritesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted" style="padding: 1.5rem;">
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">
                                            <i class="fas fa-search"></i>
                                        </div>
                                        <h5 style="margin-bottom: 0.25rem; color: var(--text-secondary, #6b7280); font-size: 0.95rem;">Search for Products</h5>
                                        <p style="color: var(--text-secondary, #9ca3af); margin: 0; font-size: 0.8rem;">Enter a search term above to find products to add to your favorites</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer" style="flex-shrink: 0; padding: 1.25rem 1.5rem; border-top: 1px solid var(--border-color, #e5e7eb); background: var(--bg-surface-hover, #f9fafb);">
                    <div class="d-flex justify-content-end w-100">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="min-width: 100px;">
                            <i class="fas fa-times"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
{% endblock content %}

{% block extra_js %}
    <!-- Load dependencies first -->
    <script src="{% static 'js/fetchData.js' %}"></script>
    
    <script>
        // Construct base URLs for favorites (remove the placeholder ID)
        const addFavoriteBase = '{% url "inventory:add_favorite" 999 %}';
        const removeFavoriteBase = '{% url "inventory:remove_favorite" 999 %}';
        
        // Remove the placeholder number and trailing slash, then add back one slash
        urls = {
            addFavorite: addFavoriteBase.replace(/\/999\/$/, '/'),
            removeFavorite: removeFavoriteBase.replace(/\/999\/$/, '/'),
            getVariants: '{% url "inventory:get_variants_for_favorites" %}',
            fetchFavorites: '{% url "inventory:fetch_favorites" %}',
        }
        
        // Ensure URLs don't have double slashes
        urls.addFavorite = urls.addFavorite.replace(/\/+/g, '/');
        urls.removeFavorite = urls.removeFavorite.replace(/\/+/g, '/');
        
        // Make urls globally accessible
        window.urls = urls;
        
        // Handle remove favorite button clicks (using event delegation for dynamically loaded content)
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-favorite-btn')) {
                const btn = e.target.closest('.remove-favorite-btn');
                const variantId = btn.dataset.variantId;
                
                if (!variantId) {
                    console.error('Variant ID not found');
                    return;
                }
                
                if (!confirm('Are you sure you want to remove this product from favorites?')) {
                    return;
                }

                // Disable button during request
                btn.disabled = true;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                const url = window.urls.removeFavorite + variantId + '/';
                const csrfToken = getCSRFToken();
                
                if (!csrfToken) {
                    alert('CSRF token not found. Please refresh the page and try again.');
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                    return;
                }
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Reload table
                        if (typeof reloadTable === 'function') {
                            reloadTable('data_table');
                        }
                        if (window.showToast) {
                            showToast(data.message, 'success');
                        } else {
                            alert(data.message);
                        }
                    } else {
                        if (window.showToast) {
                            showToast(data.message || 'Failed to remove favorite', 'error');
                        } else {
                            alert(data.message || 'Failed to remove favorite');
                        }
                        btn.disabled = false;
                        btn.innerHTML = originalHtml;
                    }
                })
                .catch(error => {
                    console.error('Error removing favorite:', error);
                    if (window.showToast) {
                        showToast('Failed to remove favorite', 'error');
                    } else {
                        alert('Failed to remove favorite');
                    }
                    btn.disabled = false;
                    btn.innerHTML = originalHtml;
                });
            }
        });
        
        // Initialize table on page load
        document.addEventListener('DOMContentLoaded', function() {
            const table = document.getElementById('data_table');
            const form = document.getElementById('searchForm');
            if (table && urls.fetchFavorites) {
                if (typeof initTableAjax === 'function') {
                    initTableAjax(form ? form.id : null, 'data_table', urls.fetchFavorites, {
                        autoLoad: true,
                        method: 'GET'
                    });
                }
                if (typeof initTableSorting === 'function') {
                    initTableSorting('data_table');
                }
            }
        });
    </script>
    
    <!-- Toggle Filters Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggleFiltersBtn');
            const filtersRow = document.getElementById('filtersRow');
            
            if (toggleBtn && filtersRow) {
                toggleBtn.addEventListener('click', function() {
                    if (filtersRow.style.display === 'none') {
                        filtersRow.style.display = 'block';
                        toggleBtn.innerHTML = '<i class="fas fa-filter"></i> Hide Filters';
                        toggleBtn.classList.add('active');
                    } else {
                        filtersRow.style.display = 'none';
                        toggleBtn.innerHTML = '<i class="fas fa-filter"></i> Filters';
                        toggleBtn.classList.remove('active');
                    }
                });
            }

            // Add Favorites Modal Functionality
            setupAddFavoritesModal();
        });

        function setupAddFavoritesModal() {
            const addFavoritesBtn = document.getElementById('addFavoritesBtn');
            const addFavoritesModal = document.getElementById('addFavoritesModal');
            const addFavoritesSearchForm = document.getElementById('addFavoritesSearchForm');

            // Open modal
            if (addFavoritesBtn && addFavoritesModal) {
                addFavoritesBtn.addEventListener('click', function() {
                    let modal;
                    if (typeof bootstrap !== 'undefined') {
                        modal = new bootstrap.Modal(addFavoritesModal);
                        modal.show();
                    } else {
                        // Fallback
                        addFavoritesModal.classList.add('show');
                        addFavoritesModal.style.display = 'block';
                    }
                    // Clear previous search
                    const searchInput = document.getElementById('addFavoritesSearchInput');
                    const tableBody = document.getElementById('addFavoritesTableBody');
                    if (searchInput) searchInput.value = '';
                    if (tableBody) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center text-muted" style="padding: 1.5rem;">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <h5 style="margin-bottom: 0.25rem; color: var(--text-secondary, #6b7280); font-size: 0.95rem;">Search for Products</h5>
                                    <p style="color: var(--text-secondary, #9ca3af); margin: 0; font-size: 0.8rem;">Enter a search term above to find products to add to your favorites</p>
                                </td>
                            </tr>
                        `;
                    }
                });
            }

            // Search form submission
            if (addFavoritesSearchForm) {
                addFavoritesSearchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    searchVariantsForFavorites();
                });
            }

            // Search variants function
            function searchVariantsForFavorites() {
                const searchInput = document.getElementById('addFavoritesSearchInput');
                const searchQuery = searchInput ? searchInput.value.trim() : '';
                const tableBody = document.getElementById('addFavoritesTableBody');

                if (!tableBody) return;

                // Show loading
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center" style="padding: 1.5rem;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-spinner fa-spin" style="color: var(--primary, #2563eb);"></i>
                            </div>
                            <p style="color: var(--text-secondary, #6b7280); margin: 0; font-size: 0.875rem;">Searching products...</p>
                        </td>
                    </tr>
                `;

                // Build URL
                const url = urls.getVariants + (searchQuery ? '?search=' + encodeURIComponent(searchQuery) : '');

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.variants.length > 0) {
                        let html = '';
                        data.variants.forEach(variant => {
                            const stockClass = parseFloat(variant.quantity) > 0 ? 'badge-success' : 'badge-danger';
                            const stockIcon = parseFloat(variant.quantity) > 0 ? 'fa-check-circle' : 'fa-times-circle';
                            html += `
                                <tr style="transition: background-color 0.2s ease;" 
                                    onmouseover="this.style.backgroundColor='var(--bg-surface-hover, #f9fafb)'" 
                                    onmouseout="this.style.backgroundColor='transparent'">
                                    <td style="padding: 0.875rem; vertical-align: middle;">
                                        <strong style="color: var(--text-primary, #111827); font-family: 'Courier New', monospace; font-size: 0.95rem;">${variant.barcode}</strong>
                                    </td>
                                    <td style="padding: 0.875rem; vertical-align: middle;">
                                        <div>
                                            <div style="font-weight: 600; color: var(--text-primary, #111827); font-size: 0.95rem; margin-bottom: 0.2rem;">${variant.product_brand}</div>
                                            ${variant.product_name ? `<small style="color: var(--text-secondary, #6b7280); font-size: 0.8rem;">${variant.product_name}</small>` : ''}
                                        </div>
                                    </td>
                                    <td style="padding: 0.875rem; vertical-align: middle;">
                                        <span style="color: var(--text-secondary, #6b7280); font-size: 0.875rem;">${variant.variant_name || '-'}</span>
                                    </td>
                                    <td style="padding: 0.875rem; vertical-align: middle;">
                                        <strong style="color: var(--primary, #2563eb); font-size: 0.95rem;">â‚¹${parseFloat(variant.final_price).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                    </td>
                                    <td style="padding: 0.875rem; vertical-align: middle;">
                                        <span class="badge ${stockClass}" style="font-size: 0.8rem; padding: 0.4rem 0.8rem; font-weight: 500;">
                                            <i class="fas ${stockIcon}"></i>
                                            ${variant.quantity}
                                        </span>
                                    </td>
                                    <td style="padding: 0.875rem; vertical-align: middle; text-align: center;">
                                        <button class="btn btn-primary btn-sm add-favorite-btn" 
                                                data-variant-id="${variant.id}"
                                                style="min-width: 120px; font-size: 0.875rem; padding: 0.5rem 1rem;">
                                            <i class="fas fa-star"></i> Add to Favorites
                                        </button>
                                    </td>
                                </tr>
                            `;
                        });
                        tableBody.innerHTML = html;
                        
                        // Attach event listeners to add buttons
                        document.querySelectorAll('.add-favorite-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const variantId = this.dataset.variantId;
                                addFavoriteToUser(variantId, this);
                            });
                        });
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center text-muted" style="padding: 1.5rem;">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <h5 style="margin-bottom: 0.25rem; color: var(--text-secondary, #6b7280); font-size: 0.95rem;">No Products Found</h5>
                                    <p style="color: var(--text-secondary, #9ca3af); margin: 0; font-size: 0.8rem;">Try a different search term</p>
                                </td>
                            </tr>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error searching variants:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger" style="padding: 1.5rem;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <h5 style="margin-bottom: 0.25rem; color: var(--danger, #dc2626); font-size: 0.95rem;">Error Loading Products</h5>
                                <p style="color: var(--text-secondary, #9ca3af); margin: 0; font-size: 0.8rem;">Please try again</p>
                            </td>
                        </tr>
                    `;
                });
            }

            // Add single favorite
            function addFavoriteToUser(variantId, buttonElement) {
                const originalHtml = buttonElement.innerHTML;
                buttonElement.disabled = true;
                buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
                
                const csrfToken = getCSRFToken();
                if (!csrfToken) {
                    alert('CSRF token not found. Please refresh the page and try again.');
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = originalHtml;
                    return;
                }

                fetch(urls.addFavorite + variantId + '/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' || data.status === 'info') {
                        // Remove the row from table
                        const row = buttonElement.closest('tr');
                        if (row) {
                            row.style.transition = 'opacity 0.3s';
                            row.style.opacity = '0';
                            setTimeout(() => {
                                row.remove();
                                // Check if table is empty
                                const tableBody = document.getElementById('addFavoritesTableBody');
                                if (tableBody && tableBody.querySelectorAll('tr').length === 0) {
                                    tableBody.innerHTML = `
                                        <tr>
                                            <td colspan="6" class="text-center text-muted" style="padding: 1.5rem;">
                                                <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">
                                                    <i class="fas fa-check-circle"></i>
                                                </div>
                                                <h5 style="margin-bottom: 0.25rem; color: var(--text-secondary, #6b7280); font-size: 0.95rem;">All products added!</h5>
                                                <p style="color: var(--text-secondary, #9ca3af); margin: 0; font-size: 0.8rem;">Search for more products to add</p>
                                            </td>
                                        </tr>
                                    `;
                                }
                            }, 300);
                        }
                        
                        // Reload favorites table
                        if (typeof reloadTable === 'function') {
                            reloadTable('data_table');
                        }
                        
                        // Show success message
                        if (window.showToast) {
                            showToast(data.message, 'success');
                        } else {
                            alert(data.message);
                        }
                    } else {
                        if (window.showToast) {
                            showToast(data.message || 'Failed to add favorite', 'error');
                        } else {
                            alert(data.message || 'Failed to add favorite');
                        }
                        buttonElement.disabled = false;
                        buttonElement.innerHTML = originalHtml;
                    }
                })
                .catch(error => {
                    console.error('Error adding favorite:', error);
                    if (window.showToast) {
                        showToast('Failed to add favorite', 'error');
                    } else {
                        alert('Failed to add favorite');
                    }
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = originalHtml;
                });
            }
        }

        // Helper function to get cookie value (make it global)
        window.getCookie = function(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };
        
        // Get CSRF token - try multiple methods (make it global)
        window.getCSRFToken = function() {
            // Method 1: Try to get from form input
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfInput && csrfInput.value) {
                return csrfInput.value;
            }
            
            // Method 2: Try to get from cookies (csrftoken is Django's default)
            const csrfToken = getCookie('csrftoken');
            if (csrfToken) {
                return csrfToken;
            }
            
            // Method 3: Try alternative cookie name
            const csrfTokenAlt = getCookie('csrf_token');
            if (csrfTokenAlt) {
                return csrfTokenAlt;
            }
            
            console.error('CSRF token not found. Available cookies:', document.cookie);
            return null;
        };
    </script>
{% endblock extra_js %}
