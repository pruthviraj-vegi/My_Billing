{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}
    My Favorite Products
{% endblock title %}
{% block content %}
    <!-- Page Header -->
    <div class="page-header">
        <h2 class="heading page-title">
            <i class="fas fa-star"></i> My Favorite Products
        </h2>
        <div class="page-actions">
            <button type="button" class="btn btn-primary" id="addFavoritesBtn">
                <i class="fas fa-plus"></i>
                Add Favorites
            </button>
            <a href="{% url 'inventory_variant:home' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back to Variants
            </a>
            <button type="button" class="btn btn-danger" id="removeSelectedBtn" style="display: none;">
                <i class="fas fa-trash"></i>
                Remove Selected
            </button>
        </div>
    </div>
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb breadcrumb-right">
        <a href="{% url 'inventory_products:home' %}" class="breadcrumb-item">Products</a>
        <span class="breadcrumb-separator">/</span>
        <a href="{% url 'inventory_variant:home' %}" class="breadcrumb-item">Variants</a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-active">Favorites</span>
    </nav>
    <!-- Search and Filter Section -->
    <div class="search-filter-section">
        <form method="get" class="search-filter-form" id="searchForm">
            <div class="search-group search-expanded">
                <i class="fas fa-search search-icon"></i>
                <div class="search-input-container">
                    <input type="search"
                           name="search"
                           class="search-input"
                           placeholder="Search favorites by name, brand, barcode..."
                           value=""
                           id="searchInput"
                           autocomplete="off"
                           autofocus>
                </div>
            </div>
            <button type="button" class="btn btn-primary" id="toggleFiltersBtn">
                <i class="fas fa-filter"></i>
                Filters
            </button>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-search"></i>
                Search
            </button>
            
            <!-- Hidden Filters Row -->
            <div class="filters-row" id="filtersRow" style="display: none;">
                <div class="filters-container">
                    <select name="status" class="filter-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="DISCONTINUED">Discontinued</option>
                    </select>
                    <select name="stock" class="filter-select" id="stockFilter">
                        <option value="">All Stock</option>
                        <option value="in_stock">In Stock</option>
                        <option value="out_of_stock">Out of Stock</option>
                        <option value="low_stock">Low Stock</option>
                    </select>
                </div>
            </div>
        </form>
    </div>
    <!-- Data Table -->
    <div class="table-container">
        <table class="data-table" id="data_table">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="selectAllCheckbox" title="Select All">
                    </th>
                    <th class="sortable" data-sort="id">ID</th>
                    <th class="sortable" data-sort="barcode">Barcode</th>
                    <th class="sortable" data-sort="product__brand">Brand</th>
                    <th class="sortable" data-sort="product__name">Product Name</th>
                    <th>Size/Color</th>
                    <th class="sortable" data-sort="quantity">Quantity</th>
                    <th class="sortable" data-sort="mrp">MRP</th>
                    <th>Discount</th>
                    <th>Final Price</th>
                    <th class="sortable" data-sort="status">Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="table_body">
                <!-- Empty table body - data will be loaded via AJAX -->
                <tr>
                    <td colspan="12" class="text-center" style="padding: 2rem;">
                        <i class="fas fa-spinner fa-spin" style="color: var(--primary); margin-right: 0.5rem;"></i>
                        Loading favorites...
                        <br><br>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="window.retryTableLoad()">
                            <i class="fas fa-refresh"></i>
                            Retry
                        </button>
                    </td>
                </tr>
            </tbody>
            <tfoot id="table_footer">
                <!-- Pagination will be loaded here via AJAX -->
            </tfoot>
        </table>
    </div>
    
    <!-- Add Favorites Modal -->
    <div class="modal fade" id="addFavoritesModal" tabindex="-1" aria-labelledby="addFavoritesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable modal-dialog-centered" style="max-width: 95vw; width: 95vw; height: 90vh; margin: auto;">
            <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">
                <div class="modal-header" style="flex-shrink: 0; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color, #e5e7eb); background: var(--bg-surface-hover, #f9fafb);">
                    <h5 class="modal-title" id="addFavoritesModalLabel" style="font-size: 1.25rem; font-weight: 600; color: var(--text-primary, #111827); margin: 0;">
                        <i class="fas fa-star text-warning"></i> Add Products to Favorites
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="flex: 1; overflow: hidden; padding: 1.5rem; display: flex; flex-direction: column;">
                    <!-- Search Section -->
                    <div class="search-filter-section mb-3" style="flex-shrink: 0;">
                        <form id="addFavoritesSearchForm">
                            <div class="d-flex gap-2 align-items-center">
                                <div class="search-group search-expanded flex-grow-1">
                                    <i class="fas fa-search search-icon"></i>
                                    <div class="search-input-container">
                                        <input type="search"
                                               name="search"
                                               class="search-input"
                                               placeholder="Search products by name, brand, barcode..."
                                               value=""
                                               id="addFavoritesSearchInput"
                                               autocomplete="off"
                                               style="font-size: 1rem; padding: 0.75rem;">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" style="min-width: 120px;">
                                    <i class="fas fa-search"></i>
                                    Search
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Variants List -->
                    <div class="table-container" style="flex: 1; overflow-y: auto; border: 1px solid var(--border-color, #e5e7eb); border-radius: 0.5rem; min-height: 0;">
                        <table class="data-table table-hover" style="margin: 0;">
                            <thead style="position: sticky; top: 0; z-index: 10; background: var(--bg-surface-hover, #f9fafb);">
                                <tr>
                                    <th width="50" style="padding: 0.875rem;">
                                        <input type="checkbox" 
                                               id="selectAllVariants" 
                                               title="Select All"
                                               style="width: 18px; height: 18px; cursor: pointer;">
                                    </th>
                                    <th style="padding: 0.875rem; font-weight: 600;">Barcode</th>
                                    <th style="padding: 0.875rem; font-weight: 600;">Product</th>
                                    <th style="padding: 0.875rem; font-weight: 600;">Variant</th>
                                    <th style="padding: 0.875rem; font-weight: 600;">Price</th>
                                    <th style="padding: 0.875rem; font-weight: 600;">Stock</th>
                                </tr>
                            </thead>
                            <tbody id="addFavoritesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center text-muted" style="padding: 1.5rem;">
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">
                                            <i class="fas fa-search"></i>
                                        </div>
                                        <h5 style="margin-bottom: 0.25rem; color: var(--text-secondary, #6b7280); font-size: 0.95rem;">Search for Products</h5>
                                        <p style="color: var(--text-secondary, #9ca3af); margin: 0; font-size: 0.8rem;">Enter a search term above to find products to add to your favorites</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer" style="flex-shrink: 0; padding: 1.25rem 1.5rem; border-top: 1px solid var(--border-color, #e5e7eb); background: var(--bg-surface-hover, #f9fafb);">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <div style="color: var(--text-secondary, #6b7280); font-size: 0.875rem;">
                            <i class="fas fa-info-circle"></i>
                            <span id="selectedCount">0</span> product(s) selected
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="min-width: 100px;">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button type="button" class="btn btn-primary" id="addSelectedFavoritesBtn" disabled style="min-width: 150px;">
                                <i class="fas fa-star"></i>
                                Add Selected
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
{% endblock content %}

{% block extra_js %}
    <!-- Load dependencies first -->
    <script src="{% static 'js/fetchData.js' %}"></script>
    
    <script>
        urls = {
            fetch: '{% url "inventory_variant:fetch_favorites" %}',
            addBulk: '{% url "inventory_variant:add_favorites_bulk" %}',
            getVariants: '{% url "inventory_variant:get_variants_for_favorites" %}',
        }
    </script>
    
    <!-- Toggle Filters Functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('toggleFiltersBtn');
            const filtersRow = document.getElementById('filtersRow');
            
            if (toggleBtn && filtersRow) {
                toggleBtn.addEventListener('click', function() {
                    if (filtersRow.style.display === 'none') {
                        filtersRow.style.display = 'block';
                        toggleBtn.innerHTML = '<i class="fas fa-filter"></i> Hide Filters';
                        toggleBtn.classList.add('active');
                    } else {
                        filtersRow.style.display = 'none';
                        toggleBtn.innerHTML = '<i class="fas fa-filter"></i> Filters';
                        toggleBtn.classList.remove('active');
                    }
                });
            }

            // Select all checkbox
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const removeSelectedBtn = document.getElementById('removeSelectedBtn');
            
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.favorite-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });
                    updateRemoveButton();
                });
            }

            // Update remove button visibility
            function updateRemoveButton() {
                const checked = document.querySelectorAll('.favorite-checkbox:checked');
                if (removeSelectedBtn) {
                    removeSelectedBtn.style.display = checked.length > 0 ? 'inline-block' : 'none';
                }
            }

            // Individual checkbox handling
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('favorite-checkbox')) {
                    updateRemoveButton();
                    updateSelectAllState();
                }
            });

            function updateSelectAllState() {
                const checkboxes = document.querySelectorAll('.favorite-checkbox');
                if (checkboxes.length === 0) return;
                
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                const someChecked = Array.from(checkboxes).some(cb => cb.checked);
                
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = someChecked && !allChecked;
                }
            }

            // Remove selected favorites
            if (removeSelectedBtn) {
                removeSelectedBtn.addEventListener('click', function() {
                    const checked = document.querySelectorAll('.favorite-checkbox:checked');
                    if (checked.length === 0) return;

                    if (!confirm(`Are you sure you want to remove ${checked.length} favorite(s)?`)) {
                        return;
                    }

                    const variantIds = Array.from(checked).map(cb => parseInt(cb.dataset.variantId));
                    
                    fetch(urls.removeBulk, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ variant_ids: variantIds })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Reload table
                            reloadTable('data_table');
                            if (window.showToast) {
                                showToast(data.message, 'success');
                            }
                        } else {
                            if (window.showToast) {
                                showToast(data.message || 'Failed to remove favorites', 'error');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error removing favorites:', error);
                        if (window.showToast) {
                            showToast('Failed to remove favorites', 'error');
                        }
                    });
                });
            }

            // Initialize table AJAX - wait for fetchData.js to load
            function initializeTable() {
                const searchForm = document.getElementById('searchForm');
                if (!searchForm) return;
                
                if (typeof initTableAjax !== 'undefined') {
                    // Use direct function call (preferred method)
                    initTableAjax('searchForm', 'data_table', urls.fetch, {
                        loadingText: 'Loading favorites...',
                        autoLoad: true
                    }, false);
                    
                    // Initialize table sorting
                    if (typeof initTableSorting !== 'undefined') {
                        initTableSorting('data_table');
                    }
                } else if (typeof window.$ === 'function') {
                    // Fallback to jQuery extension if available
                    try {
                        const $form = window.$('#searchForm');
                        if ($form.length && typeof $form.ajax === 'function') {
                            $form.ajax({
                                tableId: 'data_table',
                                url: urls.fetch,
                                placeholder: 'Loading favorites...',
                                includeInputs: false
                            });
                        }
                    } catch (e) {
                        console.error('Error initializing table:', e);
                    }
                } else {
                    // Final fallback: manual initialization
                    if (typeof loadTableData !== 'undefined') {
                        searchForm.addEventListener('submit', function(e) {
                            e.preventDefault();
                            loadTableData('searchForm', 'data_table', urls.fetch);
                        });
                        // Load initial data
                        loadTableData('searchForm', 'data_table', urls.fetch);
                    }
                }
            }
            
            // Try to initialize immediately
            initializeTable();
            
            // If functions not available, wait a bit and try again
            if (typeof initTableAjax === 'undefined' && typeof loadTableData === 'undefined') {
                setTimeout(initializeTable, 100);
            }

            // Update select all state after table reload
            const originalReloadTable = window.reloadTable;
            if (originalReloadTable) {
                window.reloadTable = function(tableId) {
                    originalReloadTable(tableId);
                    setTimeout(() => {
                        updateSelectAllState();
                        updateRemoveButton();
                    }, 100);
                };
            }

            // Add Favorites Modal Functionality
            setupAddFavoritesModal();
        });

        function setupAddFavoritesModal() {
            const addFavoritesBtn = document.getElementById('addFavoritesBtn');
            const addFavoritesModal = document.getElementById('addFavoritesModal');
            const addFavoritesSearchForm = document.getElementById('addFavoritesSearchForm');
            const selectAllVariants = document.getElementById('selectAllVariants');
            const addSelectedFavoritesBtn = document.getElementById('addSelectedFavoritesBtn');
            const selectedCountSpan = document.getElementById('selectedCount');

            // Open modal
            if (addFavoritesBtn && addFavoritesModal) {
                addFavoritesBtn.addEventListener('click', function() {
                    let modal;
                    if (typeof bootstrap !== 'undefined') {
                        modal = new bootstrap.Modal(addFavoritesModal);
                        modal.show();
                    } else {
                        // Fallback
                        addFavoritesModal.classList.add('show');
                        addFavoritesModal.style.display = 'block';
                    }
                    // Clear previous search
                    const searchInput = document.getElementById('addFavoritesSearchInput');
                    const tableBody = document.getElementById('addFavoritesTableBody');
                    if (searchInput) searchInput.value = '';
                    if (tableBody) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center text-muted" style="padding: 1.5rem;">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <h5 style="margin-bottom: 0.25rem; color: var(--text-secondary, #6b7280); font-size: 0.95rem;">Search for Products</h5>
                                    <p style="color: var(--text-secondary, #9ca3af); margin: 0; font-size: 0.8rem;">Enter a search term above to find products to add to your favorites</p>
                                </td>
                            </tr>
                        `;
                    }
                    updateSelectedCount();
                });
            }

            // Search form submission
            if (addFavoritesSearchForm) {
                addFavoritesSearchForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    searchVariantsForFavorites();
                });
            }

            // Select all variants in modal
            if (selectAllVariants) {
                selectAllVariants.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('#addFavoritesTableBody .variant-select-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = this.checked;
                    });
                    updateSelectedCount();
                });
            }

            // Update selected count
            function updateSelectedCount() {
                const checked = document.querySelectorAll('#addFavoritesTableBody .variant-select-checkbox:checked');
                const count = checked.length;
                const selectedCountElement = document.getElementById('selectedCount');
                if (selectedCountElement) {
                    selectedCountElement.textContent = count;
                }
                if (addSelectedFavoritesBtn) {
                    addSelectedFavoritesBtn.disabled = count === 0;
                    if (count > 0) {
                        addSelectedFavoritesBtn.innerHTML = `<i class="fas fa-star"></i> Add Selected (${count})`;
                    } else {
                        addSelectedFavoritesBtn.innerHTML = `<i class="fas fa-star"></i> Add Selected`;
                    }
                }
                // Update select all checkbox
                if (selectAllVariants) {
                    const allCheckboxes = document.querySelectorAll('#addFavoritesTableBody .variant-select-checkbox');
                    if (allCheckboxes.length > 0) {
                        selectAllVariants.checked = allCheckboxes.length === count && count > 0;
                        selectAllVariants.indeterminate = count > 0 && count < allCheckboxes.length;
                    } else {
                        selectAllVariants.checked = false;
                        selectAllVariants.indeterminate = false;
                    }
                }
            }

            // Listen for checkbox changes in modal
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('variant-select-checkbox')) {
                    updateSelectedCount();
                }
            });

            // Search variants function
            function searchVariantsForFavorites() {
                const searchInput = document.getElementById('addFavoritesSearchInput');
                const searchQuery = searchInput ? searchInput.value.trim() : '';
                const tableBody = document.getElementById('addFavoritesTableBody');

                if (!tableBody) return;

                // Show loading
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center" style="padding: 1.5rem;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-spinner fa-spin" style="color: var(--primary, #2563eb);"></i>
                            </div>
                            <p style="color: var(--text-secondary, #6b7280); margin: 0; font-size: 0.875rem;">Searching products...</p>
                        </td>
                    </tr>
                `;

                // Build URL
                const url = urls.getVariants + (searchQuery ? '?search=' + encodeURIComponent(searchQuery) : '');

                fetch(url, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.variants.length > 0) {
                        let html = '';
                        data.variants.forEach(variant => {
                            const stockClass = parseFloat(variant.quantity) > 0 ? 'badge-success' : 'badge-danger';
                            const stockIcon = parseFloat(variant.quantity) > 0 ? 'fa-check-circle' : 'fa-times-circle';
                            html += `
                                <tr style="transition: background-color 0.2s ease;" 
                                    onmouseover="this.style.backgroundColor='var(--bg-surface-hover, #f9fafb)'" 
                                    onmouseout="this.style.backgroundColor='transparent'">
                                    <td style="padding: 0.875rem; vertical-align: middle;">
                                        <input type="checkbox" 
                                               class="variant-select-checkbox" 
                                               data-variant-id="${variant.id}"
                                               style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary, #2563eb);">
                                    </td>
                                    <td style="padding: 0.875rem; vertical-align: middle;">
                                        <strong style="color: var(--text-primary, #111827); font-family: 'Courier New', monospace; font-size: 0.95rem;">${variant.barcode}</strong>
                                    </td>
                                    <td style="padding: 0.875rem; vertical-align: middle;">
                                        <div>
                                            <div style="font-weight: 600; color: var(--text-primary, #111827); font-size: 0.95rem; margin-bottom: 0.2rem;">${variant.product_brand}</div>
                                            ${variant.product_name ? `<small style="color: var(--text-secondary, #6b7280); font-size: 0.8rem;">${variant.product_name}</small>` : ''}
                                        </div>
                                    </td>
                                    <td style="padding: 0.875rem; vertical-align: middle;">
                                        <span style="color: var(--text-secondary, #6b7280); font-size: 0.875rem;">${variant.variant_name || '-'}</span>
                                    </td>
                                    <td style="padding: 0.875rem; vertical-align: middle;">
                                        <strong style="color: var(--primary, #2563eb); font-size: 0.95rem;">â‚¹${parseFloat(variant.final_price).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
                                    </td>
                                    <td style="padding: 0.875rem; vertical-align: middle;">
                                        <span class="badge ${stockClass}" style="font-size: 0.8rem; padding: 0.4rem 0.8rem; font-weight: 500;">
                                            <i class="fas ${stockIcon}"></i>
                                            ${variant.quantity}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        });
                        tableBody.innerHTML = html;
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center text-muted" style="padding: 1.5rem;">
                                    <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">
                                        <i class="fas fa-search"></i>
                                    </div>
                                    <h5 style="margin-bottom: 0.25rem; color: var(--text-secondary, #6b7280); font-size: 0.95rem;">No Products Found</h5>
                                    <p style="color: var(--text-secondary, #9ca3af); margin: 0; font-size: 0.8rem;">Try a different search term</p>
                                </td>
                            </tr>
                        `;
                    }
                    updateSelectedCount();
                })
                .catch(error => {
                    console.error('Error searching variants:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger" style="padding: 1.5rem;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.5;">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <h5 style="margin-bottom: 0.25rem; color: var(--danger, #dc2626); font-size: 0.95rem;">Error Loading Products</h5>
                                <p style="color: var(--text-secondary, #9ca3af); margin: 0; font-size: 0.8rem;">Please try again</p>
                            </td>
                        </tr>
                    `;
                    updateSelectedCount();
                });
            }

            // Add selected favorites
            if (addSelectedFavoritesBtn) {
                addSelectedFavoritesBtn.addEventListener('click', function() {
                    const checked = document.querySelectorAll('#addFavoritesTableBody .variant-select-checkbox:checked');
                    if (checked.length === 0) return;

                    const variantIds = Array.from(checked).map(cb => parseInt(cb.dataset.variantId));

                    // Disable button during request
                    addSelectedFavoritesBtn.disabled = true;
                    addSelectedFavoritesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

                    fetch(urls.addBulk, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ variant_ids: variantIds })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Close modal
                            if (typeof bootstrap !== 'undefined') {
                                const modal = bootstrap.Modal.getInstance(addFavoritesModal);
                                if (modal) modal.hide();
                            } else {
                                addFavoritesModal.classList.remove('show');
                                addFavoritesModal.style.display = 'none';
                            }
                            
                            // Reload favorites table
                            if (typeof reloadTable === 'function') {
                                reloadTable('data_table');
                            }
                            
                            // Show success message
                            if (window.showToast) {
                                showToast(data.message, 'success');
                            } else {
                                alert(data.message);
                            }
                        } else {
                            if (window.showToast) {
                                showToast(data.message || 'Failed to add favorites', 'error');
                            } else {
                                alert(data.message || 'Failed to add favorites');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error adding favorites:', error);
                        if (window.showToast) {
                            showToast('Failed to add favorites', 'error');
                        } else {
                            alert('Failed to add favorites');
                        }
                    })
                    .finally(() => {
                        // Re-enable button and reset
                        addSelectedFavoritesBtn.disabled = true;
                        updateSelectedCount();
                    });
                });
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock extra_js %}
