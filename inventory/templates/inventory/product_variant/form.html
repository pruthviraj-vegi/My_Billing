{% extends "base.html" %}
{% load static %}
{% block title %}
  {% if variant %}
    Edit Product Variant
  {% else %}
    Create Product Variant
  {% endif %}
{% endblock title %}
{% block content %}
  <!-- Page Header -->
  <div class="page-header">
    <h2 class="page-title">
      {% if variant %}
        Edit Product Variant
      {% else %}
        {% if is_first_variant %}
          Create First Variant for {{ product.display_name }}
        {% else %}
          Create New Product Variant
        {% endif %}
      {% endif %}
    </h2>
    <div class="page-actions">
      {% if variant %}
        <a href="{% url 'inventory_products:details' variant.product.id %}"
           class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          Back to Product
        </a>
      {% else %}
        <a href="{% url 'inventory_products:details' product.id %}"
           class="btn btn-secondary">
          <i class="fas fa-list"></i>
          Back to Variants
        </a>
      {% endif %}
    </div>
  </div>
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb breadcrumb-right">
    <a href="{% url 'inventory:dashboard' %}" class="breadcrumb-item">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    {% if variant %}
      <a href="{% url 'inventory_products:details' variant.product.id %}"
         class="breadcrumb-item">{{ variant.product.display_name }}</a>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-active">Edit</span>
    {% else %}
      <a href="{% url 'inventory_products:details' product.id %}"
         class="breadcrumb-item">{{ product.display_name }}</a>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-active">Create New Variant</span>
    {% endif %}
  </nav>
  <!-- Product Variant Form -->
  <div class="form-container">
    <div class="form-card">
      <form method="post" class="details-form" novalidate autocomplete="off" data-prevent-double-submit>
        {% csrf_token %}
        <!-- Form Errors -->
        
        {% if not variant %}
          <!-- Supplier Invoice Section -->
          <div class="form-section">
            <h5 class="section-title">Supplier Invoice</h5>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group {% if form.supplier_invoice.errors %}has-error{% endif %}">
                  <label for="{{ form.supplier_invoice.id_for_label }}" class="form-label">{{ form.supplier_invoice.label }}</label>
                  {{ form.supplier_invoice }}
                  <small class="form-help {% if form.supplier_invoice.errors %}has-error{% endif %}">
                    {% if form.supplier_invoice.errors %}
                      {% for error in form.supplier_invoice.errors %}
                        <span class="form-error-inline">
                          <i class="fas fa-exclamation-circle"></i>
                          {{ error }}
                        </span>  
                      {% endfor %}
                    {% else %}
                      <span class="form-help-text">Select the supplier invoice for this product</span>
                    {% endif %}
                  </small>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
        <!-- Variant Details Section -->
        <div class="form-section">
          <h5 class="section-title">Variant Details</h5>
          
          <!-- Row 1: Size and Color -->
          <div class="row">
            <!-- Row 2: Quantity and Minimum Quantity -->
            <div class="col-md-3">
              <div class="form-group {% if form.quantity.errors %}has-error{% endif %}">
                <label for="{{ form.quantity.id_for_label }}" class="form-label">{{ form.quantity.label }}</label>
                {{ form.quantity }}
                <small class="form-help {% if form.quantity.errors %}has-error{% endif %}">
                  {% if form.quantity.errors %}
                    {% for error in form.quantity.errors %}
                      <span class="form-error-inline">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ error }}
                      </span>  
                    {% endfor %}
                  {% else %}
                    <span class="form-help-text">e.g., 10, 25, 50 (initial stock quantity)</span>
                  {% endif %}
                </small>
              </div>
            </div>
            
            <!-- Row 3: Purchase Price and Selling Price -->
            <div class="col-md-3">
              <div class="form-group {% if form.purchase_price.errors %}has-error{% endif %}">
                <label for="{{ form.purchase_price.id_for_label }}" class="form-label">{{ form.purchase_price.label }}</label>
                {{ form.purchase_price }}
                <small class="form-help {% if form.purchase_price.errors %}has-error{% endif %}">
                  {% if form.purchase_price.errors %}
                    {% for error in form.purchase_price.errors %}
                      <span class="form-error-inline">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ error }}
                      </span>  
                    {% endfor %}
                  {% else %}
                    <span class="form-help-text">e.g., 500.00, 750.50 (cost price per unit)</span>
                  {% endif %}
                </small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group {% if form.mrp.errors %}has-error{% endif %}">
                <label for="{{ form.mrp.id_for_label }}" class="form-label">{{ form.mrp.label }}</label>
                {{ form.mrp }}
                <small class="form-help {% if form.mrp.errors %}has-error{% endif %}">
                  {% if form.mrp.errors %}
                    {% for error in form.mrp.errors %}
                      <span class="form-error-inline">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ error }}
                      </span>  
                    {% endfor %}
                  {% else %}
                    <span class="form-help-text">e.g., 800.00, 1200.00 (selling price per unit)</span>
                  {% endif %}
                </small>
              </div>
            </div>
            <!-- Row 4: Discount Percentage -->
            <div class="col-md-3">
              <div class="form-group {% if form.discount_percentage.errors %}has-error{% endif %}">
                <label for="{{ form.discount_percentage.id_for_label }}" class="form-label">
                  {{ form.discount_percentage.label }}
                </label>
                {{ form.discount_percentage }}
                <small class="form-help {% if form.discount_percentage.errors %}has-error{% endif %}">
                  {% if form.discount_percentage.errors %}
                    {% for error in form.discount_percentage.errors %}
                      <span class="form-error-inline">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ error }}
                      </span>  
                    {% endfor %}
                  {% else %}
                    <span class="form-help-text">e.g., 10.00, 15.50 (discount percentage)</span>
                  {% endif %}
                </small>
              </div>
            </div>
            
            <div class="col-md-3">
              <div class="form-group {% if form.size.errors %}has-error{% endif %}">
                <label for="{{ form.size.id_for_label }}" class="form-label">{{ form.size.label }}</label>
                <div class="input-group">{{ form.size }}</div>
                <small class="form-help {% if form.size.errors %}has-error{% endif %}">
                  {% if form.size.errors %}
                    {% for error in form.size.errors %}
                      <span class="form-error-inline">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ error }}
                      </span>  
                    {% endfor %}
                  {% else %}
                    <span class="form-help-text">e.g., S, M, L, XL, XXL</span>
                  {% endif %}
                </small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group {% if form.color.errors %}has-error{% endif %}">
                <label for="{{ form.color.id_for_label }}" class="form-label">{{ form.color.label }}</label>
                <div class="input-group">{{ form.color }}</div>
                <small class="form-help {% if form.color.errors %}has-error{% endif %}">
                  {% if form.color.errors %}
                    {% for error in form.color.errors %}
                      <span class="form-error-inline">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ error }}
                      </span>  
                    {% endfor %}
                  {% else %}
                    <span class="form-help-text">e.g., Red, Blue, Black, White</span>
                  {% endif %}
                </small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group {% if form.commission_percentage.errors %}has-error{% endif %}">
                <label for="{{ form.commission_percentage.id_for_label }}"
                       class="form-label">{{ form.commission_percentage.label }}</label>
                <div class="input-group">{{ form.commission_percentage }}</div>
                <small class="form-help {% if form.commission_percentage.errors %}has-error{% endif %}">
                  {% if form.commission_percentage.errors %}
                    {% for error in form.commission_percentage.errors %}
                      <span class="form-error-inline">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ error }}
                      </span>  
                    {% endfor %}
                  {% else %}
                    <span class="form-help-text">e.g., 10.00, 15.50 (commission percentage)</span>
                  {% endif %}
                </small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group {% if form.minimum_quantity.errors %}has-error{% endif %}">
                <label for="{{ form.minimum_quantity.id_for_label }}" class="form-label">{{ form.minimum_quantity.label }}</label>
                {{ form.minimum_quantity }}
                <small class="form-help {% if form.minimum_quantity.errors %}has-error{% endif %}">
                  {% if form.minimum_quantity.errors %}
                    {% for error in form.minimum_quantity.errors %}
                      <span class="form-error-inline">
                        <i class="fas fa-exclamation-circle"></i>
                        {{ error }}
                      </span>  
                    {% endfor %}
                  {% else %}
                    <span class="form-help-text">e.g., 10, 25, 50 (minimum stock quantity)</span>
                  {% endif %}
                </small>
              </div>
            </div>
            
          </div>
          <!-- Row 5: Extra Attributes (Full Width) -->
          {% comment %} <div class="form-group {% if form.extra_attributes.errors %}has-error{% endif %}">
            <label for="{{ form.extra_attributes.id_for_label }}" class="form-label">{{ form.extra_attributes.label }}</label>
            {{ form.extra_attributes }}
            <small class="form-help">e.g., {"material": "cotton", "style": "casual"} (optional)</small>
            {% if form.extra_attributes.errors %}
              <div class="field-errors">
                {% for error in form.extra_attributes.errors %}
                  <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    {{ error }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </div> {% endcomment %}
          <!-- Calculations Section -->
          <div class="form-section">
            <h5 class="section-title">Calculations</h5>
            <div class="total-amount-display">
              <div class="total-row">
                <span class="total-label">GST Amount:</span>
                <span class="total-value" id="gst-amount-display">₹0.00</span>
              </div>
              <div class="total-row">
                <span class="total-label">Purchase Price (with GST):</span>
                <span class="total-value" id="purchase-with-gst-display">₹0.00</span>
              </div>
              <div class="total-row">
                <span class="total-label">Profit Margin (%):</span>
                <span class="total-value" id="profit-margin-percentage">0.00%</span>
              </div>
              <div class="total-row">
                <span class="total-label">Total Value:</span>
                <span class="total-value" id="total-value">₹0.00</span>
              </div>
              <div class="total-row">
                <span class="total-label">After Discount:</span>
                <span class="total-value" id="after-discount">₹0.00</span>
              </div>
              <div class="total-row total-final">
                <span class="total-label">Final Price:</span>
                <span class="total-value" id="final-price">₹0.00</span>
              </div>
            </div>
          </div>
        </div>
        <!-- Form Actions -->
        <div class="form-actions">
          {% if not variant %}
          <button type="submit" name="action" value="create_add" class="btn btn-outline-primary">
            <i class="fas fa-plus-circle"></i>
            Create & Add Another
          </button>
          {% endif %}
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i>
            {% if variant %}
              Update
            {% else %}
              Create
            {% endif %}
          </button>
          <a href="{% url 'inventory_products:home' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i>
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
  <!-- Simple Modals -->
  {% include "model_forms/sizes.html" %}
  {% include "model_forms/color.html" %}
{% endblock content %}
<!-- Simple Modal System -->
{% block extra_js %}
  <script src="{% static 'js/modelSetup.js' %}"></script>
  <script src="{% static 'js/wordSuggestion.js' %}"></script>
  <script>
  // Wait for DOM to be fully loaded
  $(document).ready(function() {
    
    setupModal('id_size', 'Size', 'new_size', '#add_new_size', '{% url "inventory:size_create_ajax" %}');
    setupModal('id_color', 'Color', 'new_color', '#add_new_color', '{% url "inventory:color_create_ajax" %}');
    
    // Initialize select2 for dropdowns
    $('#id_size, #id_supplier_invoice, #id_color, #id_cloth_type').select2({
      placeholder: "Type to search...",
      allowClear: true
    });
    
  });
  </script>
  <script>
  // Real-time calculations
  document.addEventListener('DOMContentLoaded', function () {
    const purchasePrice = document.getElementById('{{ form.purchase_price.id_for_label }}')
    const sellingPrice = document.getElementById('{{ form.mrp.id_for_label }}')
    const quantity = document.getElementById('{{ form.quantity.id_for_label }}')
    const discountPercentage = document.getElementById('{{ form.discount_percentage.id_for_label }}')
    const gstPercentage = '{{ gst_rate }}' || 5
  
    function updateCalculations() {
      const purchase = parseFloat(purchasePrice?.value) || 0
      const selling = parseFloat(sellingPrice?.value) || 0
      const qty = parseFloat(quantity?.value) || 0
      const discount = parseFloat(discountPercentage?.value) || 0
      const gst = parseFloat(gstPercentage) || 0
  
      // Calculate GST amount
      const gstAmount = purchase * (gst / 100)
      document.getElementById('gst-amount-display').textContent = `₹${gstAmount.toFixed(2)}`
  
      // Calculate purchase price with GST
      const purchaseWithGST = purchase + gstAmount
      document.getElementById('purchase-with-gst-display').textContent = `₹${purchaseWithGST.toFixed(2)}`
  
      // Calculate after discount (final selling price)
      const discountAmount = selling * (discount / 100)
      const afterDiscount = selling - discountAmount
      document.getElementById('after-discount').textContent = `₹${afterDiscount.toFixed(2)}`
  
      // Calculate profit margin percentage - based on final selling price vs purchase price with GST
      const profitMargin = afterDiscount - purchaseWithGST
      const profitMarginPercentage = purchaseWithGST > 0 ? (profitMargin / purchaseWithGST) * 100 : 0
      document.getElementById('profit-margin-percentage').textContent = `${profitMarginPercentage.toFixed(2)}%`
  
      // Calculate total value (purchase price × quantity)
      const totalValue = purchase * qty
      document.getElementById('total-value').textContent = `₹${totalValue.toFixed(2)}`
  
      // Calculate final price (after discount)
      const finalPrice = afterDiscount
      document.getElementById('final-price').textContent = `₹${finalPrice.toFixed(2)}`
    };
  
    // Add event listeners
    [purchasePrice, sellingPrice, quantity, discountPercentage].forEach((input) => {
      if (input) {
        input.addEventListener('input', updateCalculations)
      }
    })
  
    // Initial calculation
    updateCalculations()
  })

  </script>
  
{% endblock extra_js %}
